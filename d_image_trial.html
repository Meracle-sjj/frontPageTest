<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•è¯•ç”¨ | å›¾åƒæ•°æ®åˆæˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- GPUç›‘æ§ç»„ä»¶ - è°ƒè¯•ç‰ˆ -->
    <script src="gpu_monitor_debug.js"></script>
    <!-- JSZipåº“ç”¨äºæ‰“åŒ…ä¸‹è½½å¤šä¸ªå›¾ç‰‡æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: #f6f8fa;
            color: #23272f;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 40px 40px 40px;
        }
        h1 {
            color: #1769aa;
            font-size: 2rem;
            margin-bottom: 18px;
            font-weight: 700;
        }
        .upload-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 28px;
            font-size: 1.08rem;
            border: none;
            border-radius: 8px;
            background: #1769aa;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #125b8c;
        }
        .result-area {
            margin-top: 24px;
            text-align: center;
            min-height: 120px;
            color: #888;
            font-size: 1.08rem;
        }
        .preview-image {
            max-width: 90%;
            border-radius: 8px;
            margin-top: 12px;
            box-shadow: 0 1px 8px rgba(23,105,170,0.08);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
        #batch-training-output::-webkit-scrollbar {
            width: 8px;
        }
        #batch-training-output::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 4px;
        }
        #batch-training-output::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        #batch-training-output::-webkit-scrollbar-thumb:hover {
            background: #5a6578;
        }
        
        /* è¾“å…¥å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .dataset-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .dataset-image-item {
            flex: 0 0 auto;
            max-width: 180px;
            text-align: center;
        }
        
        .dataset-image-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .dataset-image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .dataset-image {
            max-width: 160px;
            max-height: 120px;
            border-radius: 6px;
            object-fit: cover;
        }
        
        /* è¾“å‡ºå›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .output-image-pair {
            flex: 0 0 auto;
            max-width: 380px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .output-pair-card {
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(40,167,69,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .output-pair-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.2);
        }
        
        .output-images-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: flex-start;
        }
        
        .output-single-image {
            flex: 1;
            text-align: center;
        }
        
        .output-image {
            max-width: 160px;
            max-height: 120px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #dee2e6;
        }
        
        .output-rgb-image {
            border-color: #28a745;
        }
        
        .output-depth-image {
            border-color: #6f42c1;
        }
        
        @media (max-width: 768px) {
            .dataset-image-item {
                max-width: 150px;
            }
            .dataset-image {
                max-width: 130px;
                max-height: 100px;
            }
            .output-image-pair {
                max-width: 100%;
            }
            .output-images-row {
                flex-direction: column;
                gap: 15px;
            }
            .output-image {
                max-width: 140px;
                max-height: 110px;
            }
        }
    </style>
</head>
<body>
    <div style="max-width:600px;margin:32px auto 0 auto;text-align:left;">
        <a href="index.html" style="display:inline-block;padding:8px 18px;background:#e3eef7;color:#1769aa;border-radius:6px;text-decoration:none;font-size:1.02rem;font-weight:500;box-shadow:0 1px 6px rgba(23,105,170,0.06);transition:background 0.2s;">â† è¿”å›é¦–é¡µ</a>
    </div>
    <div class="container">
        <h1>å›¾åƒç®—æ³•è¯•ç”¨ 
            <button id="download-dataset-btn" class="upload-btn" style="background:#9c27b0;margin-left:20px;display:inline-block;padding:8px 16px;font-size:0.9rem;">ä¸‹è½½æ¨èæ•°æ®é›†</button>
        </h1>
        
        <!-- é‡è¦è¯´æ˜ä¿¡æ¯ -->
        <div style="background:#e7f3ff;border:1px solid #b3d4fc;border-radius:8px;padding:18px;margin-bottom:20px;font-size:0.95rem;color:#0c5460;">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                <strong style="color:#1769aa;font-size:1.1rem;">ä½¿ç”¨è¯´æ˜</strong>
            </div>
            <div style="line-height:1.6;">
                <div style="margin-bottom:10px;">
                    <strong>1. æ¨èæ•°æ®é›†æ¥æºï¼š</strong>æœ¬ç³»ç»Ÿæä¾›çš„æ¨èæ•°æ®é›†æ¥è‡ª 
                    <a href="https://github.com/facebookresearch/NSVF#dataset" target="_blank" style="color:#1769aa;text-decoration:underline;">
                        NSVF dataset (GitHub)
                    </a>ï¼Œç‚¹å‡»ä¸Šæ–¹"ä¸‹è½½æ¨èæ•°æ®é›†"æŒ‰é’®å¯è·å–å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†ç”¨äºæµ‹è¯•ã€‚
                </div>
                <div style="margin-bottom:10px;">
                    <strong>2. è‡ªè¡Œä¸Šä¼ è¯´æ˜ï¼š</strong>è‹¥é€‰æ‹©è‡ªè¡Œä¸‹è½½æ•°æ®ï¼Œä¸Šä¼ æ—¶è¯·ä¸Šä¼ å®ä½“åç§°æ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ï¼šBikeã€Robot ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯å•ç‹¬çš„æ–‡ä»¶ã€‚
                </div>
                <div style="margin-bottom:0;">
                    <strong>3. å¿«é€Ÿä½“éªŒï¼š</strong>æœ¬æœºå·²æœ‰ä¸€éƒ¨åˆ†æµ‹è¯•æ•°æ®ï¼Œå¯ä»¥åœ¨é¡µé¢åº•éƒ¨ç‚¹å‡»"æ•°æ®é›†é¢„è§ˆ"æ¨¡å—æ¥å¿«é€ŸæŸ¥çœ‹è¾“å…¥ä¸è¾“å‡ºå¯¹æ¯”ç»“æœã€‚
                </div>
            </div>
        </div>
        
        <input type="file" id="folder-upload" webkitdirectory directory multiple class="upload-btn" style="margin-bottom:12px;">
        <button id="upload-btn" class="upload-btn" style="background:#28a745;margin-bottom:24px;" disabled>ä¸Šä¼ æ–‡ä»¶å¤¹åˆ°æœåŠ¡å™¨</button>
        <button id="clear-cache-btn" class="upload-btn" style="background:#e57373;margin-bottom:18px;">åˆ é™¤ç°æœ‰è¾“å…¥è¾“å‡º</button>
        <div class="result-area" id="result-area">è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚</div>
        
        <!-- æ‰¹é‡è®­ç»ƒç›¸å…³æŒ‰é’® -->
        <div style="border-top:2px solid #e3eef7;margin:30px 0;padding-top:20px;">
            <h3 style="color:#1769aa;margin-bottom:15px;text-align:center;">æ‰¹é‡è®­ç»ƒè„šæœ¬</h3>
            
            <!-- GPUèµ„æºæç¤º -->
            <div style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin-bottom:20px;font-size:0.95rem;color:#856404;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <strong style="color:#1769aa;">ç®—åŠ›èµ„æºæç¤º</strong>
                </div>
                <div style="line-height:1.4;">
                    ç®—åŠ›èµ„æºæœ‰é™ï¼Œå¼€å§‹æ‰§è¡Œå‰è¯·æŒ‰ <kbd style="background:#f8f9fa;border:1px solid #dee2e6;border-radius:3px;padding:2px 6px;font-size:0.85rem;">Ctrl+G</kbd> æˆ–ç‚¹å‡»å³ä¾§æŒ‰é’®æŸ¥çœ‹GPUèµ„æºã€‚
                    æœ¬GPUæ»¡è½½æ—¶æœ€å¤šèƒ½å¹¶è¡Œæ‰§è¡Œ<strong style="color:#e74c3c;">2ä¸ªæ•°æ®é›†</strong>è®­ç»ƒã€‚
                </div>
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid #ffeaa7;line-height:1.4;">
                    <strong style="color:#d63384;">è®­ç»ƒå‚æ•°è¯´æ˜:</strong> ä¸ºç¼©å‡ç­‰å¾…æ—¶é—´ï¼Œå½“å‰epochè®¾ç½®ä¸º15ï¼Œå®é™…ä½¿ç”¨æ—¶æ¨èepochè‡³å°‘ä¸º30ä»¥è·å¾—æ›´å¥½çš„æ•ˆæœã€‚
                </div>
            </div>
            
            <div style="text-align:center;margin-bottom:15px;">
                <button id="start-batch-training-btn" class="upload-btn" style="background:#4caf50;">å¯åŠ¨æ‰¹é‡è®­ç»ƒ</button>
                <button id="stop-batch-training-btn" class="upload-btn" style="background:#f44336;display:none;">åœæ­¢è®­ç»ƒ</button>
            </div>
            <div id="batch-training-output" class="result-area" style="min-height:200px;max-height:500px;overflow-y:auto;background:#1a1a1a;color:#e0e0e0;font-family:'Consolas', 'Monaco', 'Courier New', monospace;font-size:0.9rem;white-space:pre-wrap;text-align:left;display:none;padding:15px;border-radius:8px;border:1px solid #333;line-height:1.4;position:relative;"></div>
            <div id="training-status-indicator" style="display:none;text-align:center;margin-top:10px;font-size:0.8rem;color:#64748b;">
                <span id="status-text">è®­ç»ƒè¿›è¡Œä¸­...</span>
                <span id="status-dot" style="display:inline-block;width:8px;height:8px;background:#22c55e;border-radius:50%;margin-left:8px;animation:pulse 2s infinite;"></span>
            </div>
        </div>
        
        <!-- æ•°æ®é›†é¢„è§ˆï¼ˆè¾“å…¥å’Œè¾“å‡ºå¯¹æ¯”ï¼‰ -->
        <div style="border-top:2px solid #e3eef7;margin:30px 0;padding-top:20px;">
            <h3 style="color:#1769aa;margin-bottom:15px;text-align:center;">æ•°æ®é›†é¢„è§ˆï¼ˆè¾“å…¥ä¸è¾“å‡ºå¯¹æ¯”ï¼‰</h3>
            <div style="background:#e7f3ff;border:1px solid #b3d4fc;border-radius:8px;padding:15px;margin-bottom:15px;font-size:0.95rem;color:#0c5460;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <strong style="color:#1769aa;">æ•°æ®å±•ç¤ºè¯´æ˜</strong>
                </div>
                <div style="line-height:1.4;margin-bottom:10px;">
                    æœ¬æœºä¸Šå·²å­˜æœ‰éƒ¨åˆ†æµ‹è¯•æ•°æ®ï¼Œç›´æ¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å³å¯å±•ç¤ºè¾“å…¥ä¸è¾“å‡ºå¯¹æ¯”æ•ˆæœã€‚
                    è‹¥æƒ³ä½“éªŒå®Œæ•´çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œè¯·å…ˆç‚¹å‡»"åˆ é™¤ç°æœ‰è¾“å…¥è¾“å‡º"æŒ‰é’®æ¸…ç†ç°æœ‰æ•°æ®ï¼Œç„¶åé‡æ–°ä¸Šä¼ æ•°æ®é›†å¹¶æ‰§è¡Œæ‰¹é‡è®­ç»ƒã€‚
                </div>
                <div style="line-height:1.4;padding-top:10px;border-top:1px solid #b3d4fc;color:#0c5460;">
                    <strong style="color:#6f42c1;">éšæœºå±•ç¤ºè¯´æ˜:</strong> æ¯æ¬¡å±•ç¤ºçš„ä¸ºéšæœºé€‰å–çš„5ç»„è¾“å…¥å’Œ5ç»„è¾“å‡ºå›¾ç‰‡ï¼Œç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"æŒ‰é’®å¯é‡æ–°éšæœºé€‰æ‹©5ç»„è¾“å…¥å’Œè¾“å‡ºè¿›è¡Œå±•ç¤ºã€‚
                </div>
            </div>
            <div style="text-align:center;margin-bottom:15px;">
                <button id="load-comparison-preview-btn" class="upload-btn" style="background:#1769aa;">åŠ è½½æ•°æ®é›†å¯¹æ¯”é¢„è§ˆ</button>
                <button id="refresh-comparison-preview-btn" class="upload-btn" style="background:#17a2b8;display:none;">åˆ·æ–°é¢„è§ˆ</button>
            </div>
            <div id="comparison-preview-container" style="display:none;">
                <!-- æ•°æ®é›†å¯¹æ¯”é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
        
        <button id="download-results-btn" class="upload-btn" style="background:#4caf50;margin-bottom:18px;display:none;">ä¿å­˜è¾“å‡ºå›¾ç‰‡åˆ°æœ¬åœ°</button>
        <button id="download-all-btn" class="upload-btn" style="background:#1769aa;margin-bottom:18px;display:none;">ä¸‹è½½å…¨éƒ¨ç»“æœ</button>
        <div id="infer-result" class="result-area"></div>
        <div style="text-align:center;color:#888;font-size:1.02rem;margin-top:38px;">
            å‰åç«¯æŠ€æœ¯æ”¯æŒï¼šæ–½é’§èˆ°
        </div>
    </div>
    
    <script>
        // åˆ é™¤ç°æœ‰è¾“å…¥è¾“å‡ºæŒ‰é’®äº‹ä»¶
        document.getElementById('clear-cache-btn').onclick = function() {
            const inferResult = document.getElementById('infer-result');
            inferResult.innerHTML = '';
            result.innerHTML = 'æ­£åœ¨åˆ é™¤ç°æœ‰è¾“å…¥è¾“å‡º...';
            // éšè—ä¸‹è½½æŒ‰é’®å¹¶æ¸…ç©ºç»“æœæ•°æ®
            downloadBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            currentResultImages = [];
            
            fetch('/clear_cache/image', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        result.innerHTML = `<div style="color:#1769aa;">${data.message}</div>`;
                    } else {
                        result.innerHTML = `<div style="color:red;">${data.error || 'åˆ é™¤å¤±è´¥'}</div>`;
                    }
                    // æ¸…ç©ºæœ¬åœ°çŠ¶æ€
                    selectedFiles = [];
                    uploadBtn.disabled = true;
                    uploadBtn.style.background = '#ccc';
                })
                .catch(err => {
                    result.innerHTML = `<div style="color:red;">åˆ é™¤å¤±è´¥ï¼š${err}</div>`;
                });
        };
        
        const upload = document.getElementById('folder-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const result = document.getElementById('result-area');
        const downloadBtn = document.getElementById('download-results-btn');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const downloadDatasetBtn = document.getElementById('download-dataset-btn');
        let selectedFiles = [];
        let selectedFolderName = '';
        let currentResultImages = []; // å­˜å‚¨å½“å‰å¤„ç†ç»“æœçš„å›¾ç‰‡æ•°æ®

        // æ•°æ®é›†ä¸‹è½½æŒ‰é’®äº‹ä»¶
        downloadDatasetBtn.onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'æ­£åœ¨å‡†å¤‡æ•°æ®é›†...';
            
            // æ˜¾ç¤ºä¸‹è½½æç¤º
            result.innerHTML = '<div style="color:#ff9800;font-weight:bold;">ğŸ“¦ æ­£åœ¨æ‰“åŒ…æ•°æ®é›†æ–‡ä»¶ï¼Œæ•°æ®é›†è¾ƒå¤§(çº¦300MB)ï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';
            
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            
            // è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5åˆ†é’Ÿè¶…æ—¶
            
            fetch(`/download_dataset/image?t=${timestamp}`, {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // æ˜¾ç¤ºä¸‹è½½è¿›åº¦
                    result.innerHTML = '<div style="color:#1769aa;font-weight:bold;">ğŸ“¥ æ•°æ®é›†æ‰“åŒ…å®Œæˆï¼Œæ­£åœ¨ä¸‹è½½...</div>';
                    
                    // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'image_dataset.zip'; // é»˜è®¤æ–‡ä»¶å
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    result.innerHTML = '<div style="color:#4caf50;font-weight:bold;">âœ… æ•°æ®é›†ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹</div>';
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 1000);
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    let errorMsg = 'æ•°æ®é›†ä¸‹è½½å¤±è´¥';
                    
                    if (err.name === 'AbortError') {
                        errorMsg = 'ä¸‹è½½è¶…æ—¶ï¼Œæ•°æ®é›†è¿‡å¤§ï¼Œè¯·ç¨åé‡è¯•';
                    } else if (err.message.includes('HTTP')) {
                        errorMsg = `æœåŠ¡å™¨é”™è¯¯: ${err.message}`;
                    } else {
                        errorMsg = `ä¸‹è½½å¤±è´¥: ${err.message}`;
                    }
                    
                    result.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ ${errorMsg}</div>`;
                    console.error('æ•°æ®é›†ä¸‹è½½è¯¦ç»†é”™è¯¯:', err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¸‹è½½æ¨èæ•°æ®é›†';
                });
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹ä¸Šä¼ çŠ¶æ€
        window.onload = function() {
            fetch('/upload_status/image')
                .then(res => res.json())
                .then(data => {
                    if (data.has_files) {
                        const fileCount = data.total_files;
                        const latestFile = data.latest_filename;
                        result.innerHTML = `å·²ä¸Šä¼ æ–‡ä»¶å¤¹ï¼ŒåŒ…å«${fileCount}ä¸ªæ–‡ä»¶ï¼Œæœ€æ–°ï¼š${latestFile}ï¼Œä¸Šä¼ æ—¶é—´ï¼š${data.latest_upload_time}`;
                    } else {
                        result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                    }
                })
                .catch(err => {
                    result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                });
        };

        // æ–‡ä»¶å¤¹é€‰æ‹©äº‹ä»¶
        upload.onchange = function(e) {
            const files = Array.from(e.target.files);
            selectedFiles = files;
            
            if (files.length > 0) {
                // è·å–æ–‡ä»¶å¤¹åç§°ï¼ˆä»ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ä¸­æå–ï¼‰
                const firstFilePath = files[0].webkitRelativePath;
                selectedFolderName = firstFilePath.split('/')[0];
                
                // æŒ‰æ–‡ä»¶ç±»å‹åˆ†ç±»ç»Ÿè®¡
                const fileTypes = {};
                const folderStructure = {};
                
                files.forEach(file => {
                    const extension = file.name.split('.').pop().toLowerCase();
                    fileTypes[extension] = (fileTypes[extension] || 0) + 1;
                    
                    // æ„å»ºæ–‡ä»¶å¤¹ç»“æ„
                    const pathParts = file.webkitRelativePath.split('/');
                    let current = folderStructure;
                    pathParts.forEach((part, index) => {
                        if (index === pathParts.length - 1) {
                            // è¿™æ˜¯æ–‡ä»¶
                            if (!current._files) current._files = [];
                            current._files.push(part);
                        } else {
                            // è¿™æ˜¯æ–‡ä»¶å¤¹
                            if (!current[part]) current[part] = {};
                            current = current[part];
                        }
                    });
                });
                
                let previewHtml = `
                    <div style="margin-bottom:15px;color:#1769aa;font-weight:bold;">
                        ğŸ“ å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${selectedFolderName} (å…± ${files.length} ä¸ªæ–‡ä»¶)
                    </div>
                `;
                
                // æ˜¾ç¤ºæ–‡ä»¶ç±»å‹ç»Ÿè®¡
                let typeStatsHtml = '<div style="margin-bottom:15px;"><strong>æ–‡ä»¶ç±»å‹ç»Ÿè®¡:</strong><br>';
                Object.entries(fileTypes).forEach(([type, count]) => {
                    const icon = getFileTypeIcon(type);
                    typeStatsHtml += `<span style="margin:5px;padding:4px 8px;background:#e3eef7;border-radius:4px;display:inline-block;">${icon} ${type.toUpperCase()}: ${count}</span>`;
                });
                typeStatsHtml += '</div>';
                
                // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„é¢„è§ˆï¼ˆåªæ˜¾ç¤ºå‰å‡ å±‚ï¼‰
                let structureHtml = '<div style="margin-bottom:15px;"><strong>æ–‡ä»¶å¤¹ç»“æ„é¢„è§ˆ:</strong><div style="font-family:monospace;background:#f8f9fa;padding:10px;border-radius:6px;font-size:0.9rem;max-height:200px;overflow-y:auto;">';
                structureHtml += renderFolderStructure(folderStructure, 0, 2); // æœ€å¤šæ˜¾ç¤º2å±‚
                structureHtml += '</div></div>';
                
                result.innerHTML = previewHtml + typeStatsHtml + structureHtml;
                uploadBtn.disabled = false;
                uploadBtn.style.background = '#28a745';
            } else {
                result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
                selectedFolderName = '';
            }
        };

        // è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
        function getFileTypeIcon(extension) {
            const iconMap = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'bmp': 'ğŸ–¼ï¸', 'tiff': 'ğŸ–¼ï¸',
                'txt': 'ğŸ“„', 'json': 'ğŸ“‹', 'xml': 'ğŸ“‹', 'csv': 'ğŸ“Š',
                'mp4': 'ğŸ¥', 'avi': 'ğŸ¥', 'mov': 'ğŸ¥',
                'zip': 'ğŸ—œï¸', 'rar': 'ğŸ—œï¸', '7z': 'ğŸ—œï¸',
                'pdf': 'ğŸ“•', 'doc': 'ğŸ“˜', 'docx': 'ğŸ“˜',
                'py': 'ğŸ', 'js': 'ğŸ’›', 'html': 'ğŸŒ', 'css': 'ğŸ¨'
            };
            return iconMap[extension] || 'ğŸ“„';
        }

        // æ¸²æŸ“æ–‡ä»¶å¤¹ç»“æ„
        function renderFolderStructure(structure, depth, maxDepth) {
            if (depth > maxDepth) return '';
            
            let html = '';
            const indent = '  '.repeat(depth);
            
            Object.entries(structure).forEach(([name, content]) => {
                if (name === '_files') {
                    // æ˜¾ç¤ºæ–‡ä»¶
                    content.slice(0, 5).forEach(fileName => {
                        html += `${indent}ğŸ“„ ${fileName}\n`;
                    });
                    if (content.length > 5) {
                        html += `${indent}... è¿˜æœ‰ ${content.length - 5} ä¸ªæ–‡ä»¶\n`;
                    }
                } else {
                    // æ˜¾ç¤ºæ–‡ä»¶å¤¹
                    html += `${indent}ğŸ“ ${name}/\n`;
                    html += renderFolderStructure(content, depth + 1, maxDepth);
                }
            });
            
            return html;
        }

        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆæ–‡ä»¶å¤¹æ‰¹é‡ä¸Šä¼ ï¼‰
        uploadBtn.onclick = function() {
            if (selectedFiles.length === 0) return;
            
            result.innerHTML = `<div style="color:#1769aa;">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶å¤¹ "${selectedFolderName}" (${selectedFiles.length} ä¸ªæ–‡ä»¶) åˆ°æœåŠ¡å™¨...</div>`;
            uploadBtn.disabled = true;
            uploadBtn.style.background = '#ccc';
            
            let uploadCount = 0;
            let successCount = 0;
            let results = [];
            
            // åˆ›å»ºFormDataï¼ŒåŒ…å«æ–‡ä»¶å¤¹åç§°ä¿¡æ¯
            const folderFormData = new FormData();
            folderFormData.append('folder_name', selectedFolderName);
            
            selectedFiles.forEach((file, index) => {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('relative_path', file.webkitRelativePath);
                formData.append('folder_name', selectedFolderName);
                
                fetch('/upload_folder/image', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    uploadCount++;
                    if (data.msg) {
                        successCount++;
                        results.push(`âœ“ ${file.webkitRelativePath}: ${data.msg}`);
                    } else {
                        results.push(`âœ— ${file.webkitRelativePath}: ${data.error || 'ä¸Šä¼ å¤±è´¥'}`);
                    }
                    
                    // æ›´æ–°è¿›åº¦
                    const progressPercent = Math.round((uploadCount / selectedFiles.length) * 100);
                    result.innerHTML = `
                        <div style="color:#1769aa;margin-bottom:10px;">
                            ä¸Šä¼ è¿›åº¦: ${uploadCount}/${selectedFiles.length} (${progressPercent}%)
                        </div>
                        <div style="background:#e3eef7;border-radius:8px;height:20px;overflow:hidden;">
                            <div style="background:#1769aa;height:100%;width:${progressPercent}%;transition:width 0.3s;"></div>
                        </div>
                    `;
                    
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style="color:#1769aa;margin-bottom:10px;">
                                æ–‡ä»¶å¤¹ "${selectedFolderName}" ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}/${selectedFiles.length}
                            </div>
                            <div style="text-align:left;font-size:0.9rem;max-height:200px;overflow-y:auto;background:#f8f9fa;padding:10px;border-radius:6px;">
                                ${results.join('<br>')}
                            </div>
                            <div style="margin-top:10px;color:#666;font-size:0.9rem;">
                                æ–‡ä»¶å¤¹å·²ä¿å­˜åˆ°: /home/vipuser/home/img/userInput/Synthetic_NSVF/${selectedFolderName}/
                            </div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                        selectedFolderName = '';
                    }
                })
                .catch(err => {
                    uploadCount++;
                    results.push(`âœ— ${file.webkitRelativePath}: ${err}`);
                    
                    const progressPercent = Math.round((uploadCount / selectedFiles.length) * 100);
                    result.innerHTML = `
                        <div style="color:#1769aa;margin-bottom:10px;">
                            ä¸Šä¼ è¿›åº¦: ${uploadCount}/${selectedFiles.length} (${progressPercent}%)
                        </div>
                        <div style="background:#e3eef7;border-radius:8px;height:20px;overflow:hidden;">
                            <div style="background:#1769aa;height:100%;width:${progressPercent}%;transition:width 0.3s;"></div>
                        </div>
                    `;
                    
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style="color:#1769aa;margin-bottom:10px;">
                                æ–‡ä»¶å¤¹ "${selectedFolderName}" ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}/${selectedFiles.length}
                            </div>
                            <div style="text-align:left;font-size:0.9rem;max-height:200px;overflow-y:auto;background:#f8f9fa;padding:10px;border-radius:6px;">
                                ${results.join('<br>')}
                            </div>
                            <div style="margin-top:10px;color:#666;font-size:0.9rem;">
                                æ–‡ä»¶å¤¹å·²ä¿å­˜åˆ°: /home/vipuser/home/img/userInput/Synthetic_NSVF/${selectedFolderName}/
                            </div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                        selectedFolderName = '';
                    }
                });
            });
        };
        
        // ä¸‹è½½å•ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼ˆç›´æ¥ä¸‹è½½é™æ€æ–‡ä»¶ï¼‰
        function downloadImageFile(filename) {
            console.log('å°è¯•ä¸‹è½½æ–‡ä»¶:', filename);
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æµ‹è¯•é“¾æ¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
            fetch('/result/images/' + filename, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('æ–‡ä»¶å¯è®¿é—®ï¼Œå¼€å§‹ä¸‹è½½');
                        const a = document.createElement('a');
                        a.href = '/result/images/' + filename;
                        a.download = filename;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                        }, 100);
                    } else {
                        console.error('æ–‡ä»¶ä¸å¯è®¿é—®:', response.status);
                        alert('æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼š' + response.status);
                    }
                })
                .catch(err => {
                    console.error('ä¸‹è½½æ£€æŸ¥å¤±è´¥:', err);
                    alert('æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
        }

        // ä¸‹è½½ç»“æœå›¾ç‰‡æŒ‰é’®äº‹ä»¶
        document.getElementById('download-results-btn').onclick = function() {
            if (currentResultImages.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = 'æ­£åœ¨å‡†å¤‡ä¸‹è½½...';
            try {
                if (currentResultImages.length === 1) {
                    downloadImageFile(currentResultImages[0].filename);
                } else {
                    // å¤šä¸ªå›¾ç‰‡æ–‡ä»¶é€ä¸ªä¸‹è½½
                    downloadImagesSequentially(currentResultImages);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = 'ä¿å­˜è¾“å‡ºå›¾ç‰‡åˆ°æœ¬åœ°';
            }
        };

        // ä¸‹è½½å…¨éƒ¨å†…å®¹æŒ‰é’®äº‹ä»¶ï¼ˆzipæ•´ä¸ªoutputæ–‡ä»¶å¤¹ï¼‰
        document.getElementById('download-all-btn').onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'æ­£åœ¨æ‰“åŒ…...';
            
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            fetch(`/download_all_result/image?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
                    
                    // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'image_results.zip'; // é»˜è®¤æ–‡ä»¶å
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    alert('ä¸‹è½½å¤±è´¥: ' + err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¸‹è½½å…¨éƒ¨ç»“æœ';
                });
        };

        // é€ä¸ªä¸‹è½½å›¾ç‰‡æ–‡ä»¶ï¼ˆä½¿ç”¨é™æ€æ–‡ä»¶è·¯å¾„ï¼‰
        function downloadImagesSequentially(images) {
            images.forEach((image, index) => {
                setTimeout(() => {
                    const filename = image.filename;
                    downloadImageFile(filename);
                }, index * 500); // æ¯0.5ç§’ä¸‹è½½ä¸€ä¸ªï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
            });
        }

        // åŠ è½½è¾“å…¥å›¾ç‰‡ç”¨äºå¯¹æ¯”æ˜¾ç¤º
        function loadInputImagesForComparison(outputImages) {
            // é¦–å…ˆè·å–æ‰€æœ‰è¾“å…¥å›¾ç‰‡åˆ—è¡¨
            fetch('/list_input_images')
                .then(res => res.json())
                .then(inputData => {
                    if (inputData.error) {
                        console.error('è·å–è¾“å…¥å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', inputData.error);
                        outputImages.forEach((outputImage, index) => {
                            const container = document.getElementById(`input-container-${index}`);
                            if (container) {
                                container.innerHTML = `
                                    <div style="color:#dc3545;padding:80px 20px;">
                                        <div>è·å–è¾“å…¥å›¾ç‰‡åˆ—è¡¨å¤±è´¥</div>
                                        <div style="font-size:0.8rem;margin-top:5px;">${inputData.error}</div>
                                    </div>
                                `;
                            }
                        });
                        return;
                    }
                    
                    const inputImages = inputData.images || [];
                    
                    // ä¸ºæ¯ä¸ªè¾“å‡ºå›¾ç‰‡åŒ¹é…å¯¹åº”çš„è¾“å…¥å›¾ç‰‡
                    outputImages.forEach((outputImage, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (!container) return;
                        
                        // å°è¯•é€šè¿‡æ–‡ä»¶ååŒ¹é…æ‰¾åˆ°å¯¹åº”çš„è¾“å…¥å›¾ç‰‡
                        const baseName = outputImage.filename.replace(/(_processed|_result|_output)?\.(jpg|jpeg|png|bmp|tiff)$/i, '');
                        
                        // å¯»æ‰¾æœ€åŒ¹é…çš„è¾“å…¥å›¾ç‰‡
                        let matchedInput = inputImages.find(input => {
                            const inputBaseName = input.filename.replace(/\.(jpg|jpeg|png|bmp|tiff)$/i, '');
                            return inputBaseName === baseName || input.filename.includes(baseName) || baseName.includes(inputBaseName);
                        });
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªè¾“å…¥å›¾ç‰‡
                        if (!matchedInput && inputImages.length > 0) {
                            matchedInput = inputImages[0];
                        }
                        
                        if (matchedInput) {
                            container.innerHTML = `
                                <img src="/input/images/${matchedInput.filename}" 
                                     style="max-width:100%;max-height:300px;border-radius:8px;" 
                                     alt="è¾“å…¥å›¾ç‰‡"
                                     onload="this.style.display='block';"
                                     onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:80px 20px;&quot;><div>å›¾ç‰‡åŠ è½½å¤±è´¥</div><div style=&quot;font-size:0.8rem;margin-top:5px;&quot;>${matchedInput.filename}</div></div>';">
                                <div style="font-size:0.9rem;color:#333;margin-top:8px;">${matchedInput.filename}</div>
                                <div style="font-size:0.8rem;color:#999;">åŸå§‹å›¾ç‰‡ (${matchedInput.size_mb} MB)</div>
                            `;
                        } else {
                            container.innerHTML = `
                                <div style="color:#999;padding:80px 20px;">
                                    <div style="font-size:3rem;margin-bottom:10px;">ğŸ–¼ï¸</div>
                                    <div>æœªæ‰¾åˆ°å¯¹åº”çš„è¾“å…¥å›¾ç‰‡</div>
                                </div>
                            `;
                        }
                    });
                })
                .catch(err => {
                    console.error('åŠ è½½è¾“å…¥å›¾ç‰‡å¤±è´¥:', err);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    outputImages.forEach((outputImage, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (container) {
                            container.innerHTML = `
                                <div style="color:#dc3545;padding:80px 20px;">
                                    <div>åŠ è½½è¾“å…¥å›¾ç‰‡å¤±è´¥</div>
                                    <div style="font-size:0.8rem;margin-top:5px;">${err}</div>
                                </div>
                            `;
                        }
                    });
                });
        }

        // åŠ è½½è¾“å‡ºå›¾ç‰‡ç”¨äºå¯¹æ¯”æ˜¾ç¤º
        function loadOutputImagesForComparison(outputImages) {
            outputImages.forEach((outputImage, index) => {
                const container = document.getElementById(`output-container-${index}`);
                if (!container) return;
                
                container.innerHTML = `
                    <img src="/result/images/${outputImage.filename}" 
                         style="max-width:100%;max-height:300px;border-radius:8px;" 
                         alt="è¾“å‡ºå›¾ç‰‡"
                         onload="this.style.display='block';"
                         onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:80px 20px;&quot;><div>è¾“å‡ºå›¾ç‰‡åŠ è½½å¤±è´¥</div><div style=&quot;font-size:0.8rem;margin-top:5px;&quot;>${outputImage.filename}</div></div>';">
                    <div style="font-size:0.9rem;color:#333;margin-top:8px;">${outputImage.filename}</div>
                    <div style="font-size:0.8rem;color:#999;">å¤„ç†åçš„å›¾ç‰‡</div>
                `;
            });
        }

        // æ‰¹é‡è®­ç»ƒç›¸å…³å˜é‡
        let batchTrainingInterval = null;
        let batchTrainingOutput = '';
        
        // æ•°æ®é›†é¢„è§ˆç›¸å…³å˜é‡
        let inputDatasets = [];
        let outputDatasets = [];
        
        // åŠ è½½æ•°æ®é›†å¯¹æ¯”é¢„è§ˆæŒ‰é’®äº‹ä»¶
        document.getElementById('load-comparison-preview-btn').onclick = function() {
            const loadBtn = this;
            const refreshBtn = document.getElementById('refresh-comparison-preview-btn');
            const previewContainer = document.getElementById('comparison-preview-container');
            
            loadBtn.disabled = true;
            loadBtn.innerHTML = 'æ­£åœ¨æ‰«ææ•°æ®é›†...';
            
            // åŒæ—¶è·å–è¾“å…¥å’Œè¾“å‡ºæ•°æ®é›†
            Promise.all([
                fetch('/list_input_datasets').then(res => res.json()),
                fetch('/list_output_datasets').then(res => res.json())
            ])
            .then(([inputData, outputData]) => {
                inputDatasets = inputData.datasets || [];
                outputDatasets = outputData.datasets || [];
                
                if (inputDatasets.length === 0 && outputDatasets.length === 0) {
                    previewContainer.innerHTML = `
                        <div style="text-align:center;color:#6c757d;padding:40px;">
                            <div style="font-size:1.2rem;margin-bottom:10px;">æœªæ‰¾åˆ°ä»»ä½•æ•°æ®é›†</div>
                            <div style="font-size:0.9rem;">è¯·å…ˆä¸Šä¼ è¾“å…¥æ•°æ®é›†æˆ–è¿è¡Œæ‰¹é‡è®­ç»ƒä»¥ç”Ÿæˆè¾“å‡ºæ•°æ®</div>
                        </div>
                    `;
                    previewContainer.style.display = 'block';
                    loadBtn.disabled = false;
                    loadBtn.innerHTML = 'åŠ è½½æ•°æ®é›†å¯¹æ¯”é¢„è§ˆ';
                    return;
                }
                
                // æ˜¾ç¤ºæ•°æ®é›†å¯¹æ¯”é¢„è§ˆ
                displayComparisonPreview(inputDatasets, outputDatasets);
                
                // æ˜¾ç¤ºå®¹å™¨å’Œåˆ·æ–°æŒ‰é’®
                previewContainer.style.display = 'block';
                loadBtn.style.display = 'none';
                refreshBtn.style.display = 'inline-block';
            })
            .catch(err => {
                previewContainer.innerHTML = `
                    <div style="text-align:center;color:#dc3545;padding:40px;">
                        <div style="font-size:1.2rem;margin-bottom:10px;">åŠ è½½å¤±è´¥</div>
                        <div style="font-size:0.9rem;">ç½‘ç»œé”™è¯¯: ${err.message}</div>
                    </div>
                `;
                previewContainer.style.display = 'block';
                loadBtn.disabled = false;
                loadBtn.innerHTML = 'åŠ è½½æ•°æ®é›†å¯¹æ¯”é¢„è§ˆ';
            });
        };
        
        // åˆ·æ–°æ•°æ®é›†å¯¹æ¯”é¢„è§ˆæŒ‰é’®äº‹ä»¶
        document.getElementById('refresh-comparison-preview-btn').onclick = function() {
            const refreshBtn = this;
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'æ­£åœ¨åˆ·æ–°...';
            
            // é‡æ–°æ˜¾ç¤ºé¢„è§ˆï¼ˆä¼šéšæœºé€‰æ‹©æ–°çš„å›¾ç‰‡ï¼‰
            displayComparisonPreview(inputDatasets, outputDatasets);
            
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = 'åˆ·æ–°é¢„è§ˆ';
        };
        
        // æ˜¾ç¤ºè¾“å…¥æ•°æ®é›†é¢„è§ˆ
        function displayInputPreview(datasets) {
            const previewContainer = document.getElementById('input-preview-container');
            
            if (!datasets || datasets.length === 0) {
                previewContainer.innerHTML = `
                    <div style="text-align:center;color:#6c757d;padding:40px;">
                        <div style="font-size:1.2rem;">æ²¡æœ‰å¯é¢„è§ˆçš„æ•°æ®é›†</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="margin-bottom:20px;text-align:center;color:#1769aa;font-weight:bold;">
                    æ‰¾åˆ° ${datasets.length} ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ªæ•°æ®é›†éšæœºå±•ç¤º 5 å¼ å›¾ç‰‡
                </div>
            `;
            
            datasets.forEach((dataset, index) => {
                html += `
                    <div style="margin:30px 0;border:1px solid #dee2e6;border-radius:12px;padding:20px;background:#f8f9fa;">
                        <h4 style="color:#1769aa;margin-bottom:15px;text-align:center;">
                            æ•°æ®é›†: ${dataset.name} (å…± ${dataset.image_count} å¼ å›¾ç‰‡)
                        </h4>
                        <div id="dataset-${index}-images" style="display:flex;flex-wrap:wrap;gap:15px;justify-content:center;">
                            <div style="text-align:center;color:#6c757d;width:100%;padding:20px;">
                                æ­£åœ¨åŠ è½½å›¾ç‰‡...
                            </div>
                        </div>
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
            
            // å¼‚æ­¥åŠ è½½æ¯ä¸ªæ•°æ®é›†çš„å›¾ç‰‡
            datasets.forEach((dataset, index) => {
                loadDatasetImages(dataset.name, index);
            });
        }
        
        // åŠ è½½å•ä¸ªæ•°æ®é›†çš„å›¾ç‰‡
        function loadDatasetImages(datasetName, index) {
            fetch(`/get_random_dataset_images/${datasetName}?count=5`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    return res.text().then(text => {
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error(`æœåŠ¡å™¨è¿”å›éJSONæ ¼å¼æ•°æ®: ${text}`);
                        }
                    });
                })
                .then(data => {
                    const container = document.getElementById(`dataset-${index}-images`);
                    
                    if (data.error) {
                        container.innerHTML = `
                            <div style="text-align:center;color:#dc3545;width:100%;padding:20px;">
                                <div>åŠ è½½å¤±è´¥: ${data.error}</div>
                            </div>
                        `;
                        return;
                    }
                    
                    if (!data.images || data.images.length === 0) {
                        container.innerHTML = `
                            <div style="text-align:center;color:#6c757d;width:100%;padding:20px;">
                                <div>è¯¥æ•°æ®é›†ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // æ˜¾ç¤ºå›¾ç‰‡
                    let imagesHtml = '';
                    data.images.forEach((imageName, imgIndex) => {
                        imagesHtml += `
                            <div class="dataset-image-item">
                                <div class="dataset-image-card">
                                    <img src="/input/datasets/${datasetName}/rgb/${imageName}" 
                                         class="dataset-image"
                                         alt="è¾“å…¥å›¾ç‰‡"
                                         onload="this.style.display='block';"
                                         onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:60px 10px;font-size:0.8rem;&quot;>å›¾ç‰‡åŠ è½½å¤±è´¥</div>';">
                                    <div style="font-size:0.8rem;color:#6c757d;margin-top:8px;word-break:break-all;">
                                        ${imageName}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = imagesHtml;
                    container.className = 'dataset-images-container';
                })
                .catch(err => {
                    const container = document.getElementById(`dataset-${index}-images`);
                    container.innerHTML = `
                        <div style="text-align:center;color:#dc3545;width:100%;padding:20px;">
                            <div>ç½‘ç»œé”™è¯¯: ${err.message}</div>
                        </div>
                    `;
                });
        }
        
        // æ˜¾ç¤ºæ•°æ®é›†å¯¹æ¯”é¢„è§ˆ
        function displayComparisonPreview(inputDatasets, outputDatasets) {
            const previewContainer = document.getElementById('comparison-preview-container');
            
            // åˆ›å»ºæ•°æ®é›†æ˜ å°„ï¼Œæ‰¾åˆ°è¾“å…¥å’Œè¾“å‡ºçš„å¯¹åº”å…³ç³»
            const datasetMap = {};
            
            // æ·»åŠ è¾“å…¥æ•°æ®é›†
            inputDatasets.forEach(dataset => {
                if (!datasetMap[dataset.name]) {
                    datasetMap[dataset.name] = {};
                }
                datasetMap[dataset.name].input = dataset;
            });
            
            // æ·»åŠ è¾“å‡ºæ•°æ®é›†
            outputDatasets.forEach(dataset => {
                if (!datasetMap[dataset.name]) {
                    datasetMap[dataset.name] = {};
                }
                datasetMap[dataset.name].output = dataset;
            });
            
            const datasetNames = Object.keys(datasetMap);
            
            let html = `
                <div style="margin-bottom:20px;text-align:center;color:#1769aa;font-weight:bold;">
                    æ‰¾åˆ° ${datasetNames.length} ä¸ªæ•°æ®é›†ï¼Œæ¯ä¸ªæ•°æ®é›†éšæœºå±•ç¤º 5 ç»„å›¾ç‰‡å¯¹æ¯”
                </div>
            `;
            
            datasetNames.forEach((datasetName, index) => {
                const hasInput = !!datasetMap[datasetName].input;
                const hasOutput = !!datasetMap[datasetName].output;
                
                html += `
                    <div style="margin:30px 0;border:1px solid #dee2e6;border-radius:12px;padding:20px;background:#f8f9fa;">
                        <h4 style="color:#1769aa;margin-bottom:15px;text-align:center;">
                            æ•°æ®é›†: ${datasetName}
                            ${hasInput ? `<span style="color:#28a745;font-size:0.8rem;margin-left:10px;">[æœ‰è¾“å…¥]</span>` : ''}
                            ${hasOutput ? `<span style="color:#6f42c1;font-size:0.8rem;margin-left:10px;">[æœ‰è¾“å‡º]</span>` : ''}
                        </h4>
                        <div id="comparison-dataset-${index}" style="margin-top:20px;">
                            <div style="text-align:center;color:#6c757d;padding:20px;">
                                æ­£åœ¨åŠ è½½å›¾ç‰‡...
                            </div>
                        </div>
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
            
            // å¼‚æ­¥åŠ è½½æ¯ä¸ªæ•°æ®é›†çš„å›¾ç‰‡å¯¹æ¯”
            datasetNames.forEach((datasetName, index) => {
                loadComparisonImages(datasetName, index, datasetMap[datasetName]);
            });
        }
        
        // åŠ è½½æ•°æ®é›†å¯¹æ¯”å›¾ç‰‡
        function loadComparisonImages(datasetName, index, datasetInfo) {
            const container = document.getElementById(`comparison-dataset-${index}`);
            const hasInput = !!datasetInfo.input;
            const hasOutput = !!datasetInfo.output;
            
            // åˆ›å»ºPromiseæ•°ç»„
            const promises = [];
            
            if (hasInput) {
                promises.push(
                    fetch(`/get_random_dataset_images/${datasetName}?count=5`)
                        .then(res => res.json())
                        .then(data => ({ type: 'input', data }))
                );
            }
            
            if (hasOutput) {
                promises.push(
                    fetch(`/get_random_output_images/${datasetName}?count=5`)
                        .then(res => res.json())
                        .then(data => ({ type: 'output', data }))
                );
            }
            
            if (promises.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;color:#6c757d;padding:20px;">
                        è¯¥æ•°æ®é›†æ²¡æœ‰å¯æ˜¾ç¤ºçš„æ•°æ®
                    </div>
                `;
                return;
            }
            
            Promise.all(promises)
                .then(results => {
                    let inputImages = [];
                    let outputImages = [];
                    
                    results.forEach(result => {
                        if (result.type === 'input' && result.data.images) {
                            inputImages = result.data.images;
                        } else if (result.type === 'output' && result.data.images) {
                            outputImages = result.data.images;
                        }
                    });
                    
                    // ç”Ÿæˆå¯¹æ¯”æ˜¾ç¤ºHTML
                    let comparisonHtml = '';
                    
                    if (hasInput && hasOutput) {
                        // åŒæ—¶æœ‰è¾“å…¥å’Œè¾“å‡ºï¼Œæ˜¾ç¤ºå¯¹æ¯”
                        const maxCount = Math.max(inputImages.length, outputImages.length);
                        
                        comparisonHtml += `
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                                <div style="text-align:center;">
                                    <h5 style="color:#28a745;margin-bottom:15px;">è¾“å…¥å›¾ç‰‡ (${inputImages.length} å¼ )</h5>
                                </div>
                                <div style="text-align:center;">
                                    <h5 style="color:#6f42c1;margin-bottom:15px;">è¾“å‡ºå›¾ç‰‡ (${outputImages.length} ç»„)</h5>
                                </div>
                            </div>
                        `;
                        
                        for (let i = 0; i < Math.min(5, maxCount); i++) {
                            comparisonHtml += `
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;align-items:start;">
                                    <div style="text-align:center;">
                            `;
                            
                            if (i < inputImages.length) {
                                const inputImage = inputImages[i];
                                comparisonHtml += `
                                    <div style="border:1px solid #28a745;border-radius:8px;padding:10px;background:#f8fff8;">
                                        <img src="/input/datasets/${datasetName}/rgb/${inputImage}" 
                                             style="max-width:100%;max-height:200px;border-radius:6px;"
                                             alt="è¾“å…¥å›¾ç‰‡"
                                             onload="this.style.display='block';"
                                             onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:40px 10px;font-size:0.8rem;&quot;>è¾“å…¥å›¾ç‰‡åŠ è½½å¤±è´¥</div>';">
                                        <div style="font-size:0.7rem;color:#28a745;margin-top:8px;word-break:break-all;">
                                            ${inputImage}
                                        </div>
                                    </div>
                                `;
                            } else {
                                comparisonHtml += `
                                    <div style="color:#6c757d;padding:40px;border:1px dashed #dee2e6;border-radius:8px;">
                                        æ— å¯¹åº”è¾“å…¥å›¾ç‰‡
                                    </div>
                                `;
                            }
                            
                            comparisonHtml += `
                                    </div>
                                    <div style="text-align:center;">
                            `;
                            
                            if (i < outputImages.length) {
                                const outputImage = outputImages[i];
                                comparisonHtml += `
                                    <div style="border:1px solid #6f42c1;border-radius:8px;padding:10px;background:#faf8ff;">
                                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                            <div>
                                                <img src="/output/${outputImage.output_folder}/results/${outputImage.rgb_filename}" 
                                                     style="max-width:100%;max-height:120px;border-radius:4px;"
                                                     alt="è¾“å‡ºRGBå›¾ç‰‡"
                                                     onload="this.style.display='block';"
                                                     onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:20px 5px;font-size:0.7rem;&quot;>RGBå›¾åŠ è½½å¤±è´¥</div>';">
                                                <div style="font-size:0.65rem;color:#6f42c1;margin-top:4px;font-weight:bold;">
                                                    RGB (${outputImage.rgb_size_mb}MB)
                                                </div>
                                            </div>
                                            <div>
                                                <img src="/output/${outputImage.output_folder}/results/${outputImage.depth_filename}" 
                                                     style="max-width:100%;max-height:120px;border-radius:4px;"
                                                     alt="è¾“å‡ºæ·±åº¦å›¾ç‰‡"
                                                     onload="this.style.display='block';"
                                                     onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:20px 5px;font-size:0.7rem;&quot;>æ·±åº¦å›¾åŠ è½½å¤±è´¥</div>';">
                                                <div style="font-size:0.65rem;color:#6f42c1;margin-top:4px;font-weight:bold;">
                                                    æ·±åº¦ (${outputImage.depth_size_mb}MB)
                                                </div>
                                            </div>
                                        </div>
                                        <div style="font-size:0.6rem;color:#6f42c1;margin-top:8px;word-break:break-all;">
                                            ç¼–å·: ${outputImage.number}
                                        </div>
                                    </div>
                                `;
                            } else {
                                comparisonHtml += `
                                    <div style="color:#6c757d;padding:40px;border:1px dashed #dee2e6;border-radius:8px;">
                                        æ— å¯¹åº”è¾“å‡ºå›¾ç‰‡
                                    </div>
                                `;
                            }
                            
                            comparisonHtml += `
                                    </div>
                                </div>
                            `;
                        }
                    } else if (hasInput) {
                        // åªæœ‰è¾“å…¥ï¼Œæ˜¾ç¤ºè¾“å…¥å›¾ç‰‡
                        comparisonHtml += `
                            <div style="text-align:center;margin-bottom:15px;">
                                <h5 style="color:#28a745;">è¾“å…¥å›¾ç‰‡ (${inputImages.length} å¼ )</h5>
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:15px;justify-content:center;">
                        `;
                        
                        inputImages.slice(0, 5).forEach(inputImage => {
                            comparisonHtml += `
                                <div style="flex:0 0 auto;text-align:center;border:1px solid #28a745;border-radius:8px;padding:10px;background:#f8fff8;">
                                    <img src="/input/datasets/${datasetName}/rgb/${inputImage}" 
                                         style="max-width:150px;max-height:120px;border-radius:6px;"
                                         alt="è¾“å…¥å›¾ç‰‡"
                                         onload="this.style.display='block';"
                                         onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:40px 10px;font-size:0.8rem;&quot;>å›¾ç‰‡åŠ è½½å¤±è´¥</div>';">
                                    <div style="font-size:0.7rem;color:#28a745;margin-top:8px;word-break:break-all;max-width:150px;">
                                        ${inputImage}
                                    </div>
                                </div>
                            `;
                        });
                        
                        comparisonHtml += '</div>';
                    } else if (hasOutput) {
                        // åªæœ‰è¾“å‡ºï¼Œæ˜¾ç¤ºè¾“å‡ºå›¾ç‰‡
                        comparisonHtml += `
                            <div style="text-align:center;margin-bottom:15px;">
                                <h5 style="color:#6f42c1;">è¾“å‡ºå›¾ç‰‡ (${outputImages.length} ç»„)</h5>
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:15px;justify-content:center;">
                        `;
                        
                        outputImages.slice(0, 5).forEach(outputImage => {
                            comparisonHtml += `
                                <div style="flex:0 0 auto;text-align:center;border:1px solid #6f42c1;border-radius:8px;padding:10px;background:#faf8ff;">
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                                        <div>
                                            <img src="/output/${outputImage.output_folder}/results/${outputImage.rgb_filename}" 
                                                 style="max-width:80px;max-height:80px;border-radius:4px;"
                                                 alt="è¾“å‡ºRGBå›¾ç‰‡"
                                                 onload="this.style.display='block';"
                                                 onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:15px 5px;font-size:0.7rem;&quot;>RGBå›¾åŠ è½½å¤±è´¥</div>';">
                                            <div style="font-size:0.6rem;color:#6f42c1;margin-top:2px;font-weight:bold;">
                                                RGB
                                            </div>
                                        </div>
                                        <div>
                                            <img src="/output/${outputImage.output_folder}/results/${outputImage.depth_filename}" 
                                                 style="max-width:80px;max-height:80px;border-radius:4px;"
                                                 alt="è¾“å‡ºæ·±åº¦å›¾ç‰‡"
                                                 onload="this.style.display='block';"
                                                 onerror="this.parentElement.innerHTML='<div style=&quot;color:#dc3545;padding:15px 5px;font-size:0.7rem;&quot;>æ·±åº¦å›¾åŠ è½½å¤±è´¥</div>';">
                                            <div style="font-size:0.6rem;color:#6f42c1;margin-top:2px;font-weight:bold;">
                                                æ·±åº¦
                                            </div>
                                        </div>
                                    </div>
                                    <div style="font-size:0.6rem;color:#6f42c1;word-break:break-all;max-width:170px;">
                                        ç¼–å·: ${outputImage.number}
                                    </div>
                                </div>
                            `;
                        });
                        
                        comparisonHtml += '</div>';
                    }
                    
                    container.innerHTML = comparisonHtml;
                })
                .catch(err => {
                    container.innerHTML = `
                        <div style="text-align:center;color:#dc3545;padding:20px;">
                            <div>åŠ è½½å¤±è´¥: ${err.message}</div>
                        </div>
                    `;
                });
        }
        
        // å¯åŠ¨æ‰¹é‡è®­ç»ƒæŒ‰é’®äº‹ä»¶
        document.getElementById('start-batch-training-btn').onclick = function() {
            const startBtn = this;
            const stopBtn = document.getElementById('stop-batch-training-btn');
            const outputDiv = document.getElementById('batch-training-output');
            const statusIndicator = document.getElementById('training-status-indicator');
            const statusText = document.getElementById('status-text');
            
            startBtn.disabled = true;
            startBtn.innerHTML = 'æ­£åœ¨å¯åŠ¨...';
            
            // ç«‹å³æ˜¾ç¤ºè¾“å‡ºåŒºåŸŸå’Œåˆå§‹åŒ–ä¿¡æ¯
            outputDiv.style.display = 'block';
            statusIndicator.style.display = 'block';
            statusText.textContent = 'æ­£åœ¨å¯åŠ¨è®­ç»ƒè„šæœ¬...';
            outputDiv.innerHTML = '<span style="color:#06b6d4;">æ­£åœ¨å¯åŠ¨æ‰¹é‡è®­ç»ƒè„šæœ¬...</span>\n';
            batchTrainingOutput = '';
            
            fetch('/start_batch_training', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // å¯åŠ¨æˆåŠŸ
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'inline-block';
                        statusText.textContent = 'è®­ç»ƒè¿›è¡Œä¸­...';
                        outputDiv.innerHTML += '<span style="color:#22c55e;">æ‰¹é‡è®­ç»ƒè„šæœ¬å¯åŠ¨æˆåŠŸ</span>\n';
                        outputDiv.innerHTML += '<span style="color:#3b82f6;">å¼€å§‹è·å–è®­ç»ƒè¿‡ç¨‹è¾“å‡º...</span>\n\n';
                        
                        // å¼€å§‹è½®è¯¢è·å–è¾“å‡º
                        startPollingBatchTrainingOutput();
                    } else {
                        outputDiv.innerHTML += `<span style="color:#ef4444;">å¯åŠ¨å¤±è´¥: ${data.error}</span>\n`;
                        outputDiv.style.display = 'block';
                        statusIndicator.style.display = 'none';
                        startBtn.disabled = false;
                        startBtn.innerHTML = 'å¯åŠ¨æ‰¹é‡è®­ç»ƒ';
                    }
                })
                .catch(err => {
                    outputDiv.innerHTML += `<span style="color:#ef4444;">å¯åŠ¨å¤±è´¥: ${err}</span>\n`;
                    outputDiv.style.display = 'block';
                    statusIndicator.style.display = 'none';
                    startBtn.disabled = false;
                    startBtn.innerHTML = 'å¯åŠ¨æ‰¹é‡è®­ç»ƒ';
                });
        };
        
        // åœæ­¢æ‰¹é‡è®­ç»ƒæŒ‰é’®äº‹ä»¶
        document.getElementById('stop-batch-training-btn').onclick = function() {
            const startBtn = document.getElementById('start-batch-training-btn');
            const stopBtn = this;
            const outputDiv = document.getElementById('batch-training-output');
            const statusIndicator = document.getElementById('training-status-indicator');
            const statusText = document.getElementById('status-text');
            
            stopBtn.disabled = true;
            stopBtn.innerHTML = 'æ­£åœ¨åœæ­¢...';
            statusText.textContent = 'æ­£åœ¨åœæ­¢è®­ç»ƒ...';
            
            fetch('/stop_batch_training', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // åœæ­¢æˆåŠŸ
                        stopPollingBatchTrainingOutput();
                        outputDiv.innerHTML += '\n<span style="color:#ef4444;font-weight:bold;">è®­ç»ƒå·²è¢«ç”¨æˆ·åœæ­¢</span>\n';
                        statusText.textContent = 'è®­ç»ƒå·²åœæ­¢';
                        
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        setTimeout(() => {
                            startBtn.style.display = 'inline-block';
                            startBtn.disabled = false;
                            startBtn.innerHTML = 'å¯åŠ¨æ‰¹é‡è®­ç»ƒ';
                            stopBtn.style.display = 'none';
                            stopBtn.disabled = false;
                            stopBtn.innerHTML = 'åœæ­¢è®­ç»ƒ';
                            statusIndicator.style.display = 'none';
                        }, 1000);
                    } else {
                        alert('åœæ­¢å¤±è´¥: ' + data.error);
                        stopBtn.disabled = false;
                        stopBtn.innerHTML = 'åœæ­¢è®­ç»ƒ';
                        statusText.textContent = 'è®­ç»ƒè¿›è¡Œä¸­...';
                    }
                })
                .catch(err => {
                    alert('åœæ­¢å¤±è´¥: ' + err);
                    stopBtn.disabled = false;
                    stopBtn.innerHTML = 'åœæ­¢è®­ç»ƒ';
                    statusText.textContent = 'è®­ç»ƒè¿›è¡Œä¸­...';
                });
        };
        
        // æ¸…ç†ANSIè½¬ä¹‰åºåˆ—çš„å‡½æ•°
        function cleanAnsiSequences(text) {
            if (!text) return '';
            
            // ç§»é™¤ANSIé¢œè‰²ä»£ç å’Œæ§åˆ¶åºåˆ—
            return text
                // ç§»é™¤é¢œè‰²ä»£ç  (å¦‚ \033[0;31m, \033[1;33m ç­‰)
                .replace(/\x1b\[[0-9;]*m/g, '')
                // ç§»é™¤å…‰æ ‡æ§åˆ¶åºåˆ— (å¦‚ \033[1A, \033[K ç­‰)
                .replace(/\x1b\[[0-9]*[A-K]/g, '')
                // ç§»é™¤å…¶ä»–ANSIè½¬ä¹‰åºåˆ—
                .replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')
                // ç§»é™¤å¯èƒ½çš„å…¶ä»–æ§åˆ¶å­—ç¬¦
                .replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '')
                // ç§»é™¤å½¢å¦‚ [1A [K çš„åºåˆ—ï¼ˆä¸å¸¦ \x1bï¼‰
                .replace(/\[[0-9]*[A-K]/g, '')
                // ç§»é™¤ \r å›è½¦ç¬¦
                .replace(/\r/g, '')
                // å¤„ç†é‡å¤çš„ç­‰å·åˆ†éš”çº¿ï¼Œåˆå¹¶ä¸ºä¸€è¡Œ
                .replace(/={20,}/g, '='.repeat(60))
                // ç§»é™¤å¤šä½™çš„ç©ºè¡Œï¼ˆè¶…è¿‡2ä¸ªè¿ç»­ç©ºè¡Œåˆå¹¶ä¸º2ä¸ªï¼‰
                .replace(/\n{3,}/g, '\n\n')
                // ç§»é™¤è¡Œé¦–çš„å¤šä½™ç©ºæ ¼ï¼ˆä¿ç•™ç¼©è¿›ï¼‰
                .replace(/^\s+/gm, (match) => match.length > 4 ? '    ' : match);
        }
        
        // æ ¼å¼åŒ–è®­ç»ƒè¾“å‡ºï¼Œæå–å…³é”®ä¿¡æ¯å¹¶ç¾åŒ–æ˜¾ç¤º
        function formatTrainingOutput(rawOutput) {
            const cleanedOutput = cleanAnsiSequences(rawOutput);
            
            // æŒ‰è¡Œåˆ†å‰²
            const lines = cleanedOutput.split('\n');
            const formattedLines = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) {
                    formattedLines.push('');
                    continue;
                }
                
                // æ ¼å¼åŒ–ä¸åŒç±»å‹çš„è¾“å‡ºè¡Œï¼Œå¹¶æ·»åŠ HTMLæ ·å¼
                if (line.includes('è®­ç»ƒè¿›åº¦æ€»è§ˆ')) {
                    formattedLines.push(`<span style="color:#4a9eff;font-weight:bold;">${line}</span>`);
                } else if (line.includes('Epoch') && line.includes('loss=') && line.includes('PSNR=')) {
                    // è®­ç»ƒè¿›åº¦è¡Œï¼Œæå–å…³é”®ä¿¡æ¯
                    const match = line.match(/\[([^\]]+)\].*?Epoch\s+(\d+).*?(\d+%).*?loss=([\d\.]+).*?PSNR=([\d\.]+)/);
                    if (match) {
                        const [, dataset, epoch, progress, loss, psnr] = match;
                        formattedLines.push(`<span style="color:#4ade80;">[<span style="color:#60a5fa;font-weight:bold;">${dataset}</span>] Epoch ${epoch} | ${progress} | Loss: <span style="color:#fbbf24;">${loss}</span> | PSNR: <span style="color:#34d399;">${psnr}</span></span>`);
                    } else {
                        formattedLines.push(`<span style="color:#4ade80;">${line}</span>`);
                    }
                } else if (line.includes('è®­ç»ƒå®Œæˆ')) {
                    formattedLines.push(`<span style="color:#22c55e;font-weight:bold;">${line}</span>`);
                } else if (line.includes('è®­ç»ƒå¤±è´¥')) {
                    formattedLines.push(`<span style="color:#ef4444;font-weight:bold;">${line}</span>`);
                } else if (line.includes('æ­£åœ¨å¯åŠ¨') || line.includes('ç­‰å¾…ä¸­')) {
                    formattedLines.push(`<span style="color:#facc15;">${line}</span>`);
                } else if (line.includes('æ‰¾åˆ°') && line.includes('æ•°æ®é›†')) {
                    formattedLines.push(`<span style="color:#06b6d4;">${line}</span>`);
                } else if (line.includes('å¼€å§‹å¹¶è¡Œæ‰¹é‡è®­ç»ƒ')) {
                    formattedLines.push(`<span style="color:#8b5cf6;font-weight:bold;">${line}</span>`);
                } else if (line.includes('æ‰€æœ‰ä»»åŠ¡å®Œæˆ')) {
                    formattedLines.push(`<span style="color:#10b981;font-weight:bold;">${line}</span>`);
                } else if (line.includes('æˆåŠŸ') && line.includes('å¤±è´¥')) {
                    formattedLines.push(`<span style="color:#3b82f6;font-weight:bold;">${line}</span>`);
                } else if (line.startsWith('=')) {
                    formattedLines.push(`<span style="color:#64748b;">${line}</span>`);
                } else if (line.includes('éªŒè¯ç¯å¢ƒ') || line.includes('ç¯å¢ƒéªŒè¯')) {
                    formattedLines.push(`<span style="color:#0ea5e9;">${line}</span>`);
                } else if (line.includes('é”™è¯¯') || line.includes('å¤±è´¥') || line.includes('Error') || line.includes('error')) {
                    formattedLines.push(`<span style="color:#ef4444;">${line}</span>`);
                } else if (line.includes('è­¦å‘Š') || line.includes('Warning') || line.includes('warning')) {
                    formattedLines.push(`<span style="color:#f59e0b;">${line}</span>`);
                } else {
                    formattedLines.push(`<span style="color:#e5e7eb;">${line}</span>`);
                }
            }
            
            return formattedLines.join('\n');
        }

        // å¼€å§‹è½®è¯¢æ‰¹é‡è®­ç»ƒè¾“å‡º
        function startPollingBatchTrainingOutput() {
            const outputDiv = document.getElementById('batch-training-output');
            
            batchTrainingInterval = setInterval(() => {
                fetch('/get_batch_training_output')
                    .then(res => res.json())
                    .then(data => {
                        if (data.output) {
                            // æ¸…ç†ANSIåºåˆ—å¹¶æ ¼å¼åŒ–è¾“å‡º
                            const formattedOutput = formatTrainingOutput(data.output);
                            outputDiv.innerHTML = formattedOutput;
                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                        
                        if (data.completed) {
                            // è®­ç»ƒå®Œæˆ
                            stopPollingBatchTrainingOutput();
                            
                            const startBtn = document.getElementById('start-batch-training-btn');
                            const stopBtn = document.getElementById('stop-batch-training-btn');
                            const statusIndicator = document.getElementById('training-status-indicator');
                            const statusText = document.getElementById('status-text');
                            
                            if (data.success) {
                                outputDiv.innerHTML += '\n<span style="color:#22c55e;font-weight:bold;">æ‰¹é‡è®­ç»ƒæˆåŠŸå®Œæˆï¼</span>\n';
                                statusText.textContent = 'è®­ç»ƒå®Œæˆï¼';
                            } else {
                                outputDiv.innerHTML += '\n<span style="color:#f59e0b;font-weight:bold;">æ‰¹é‡è®­ç»ƒå¤±è´¥æˆ–è¢«ä¸­æ–­</span>\n';
                                statusText.textContent = 'è®­ç»ƒå¤±è´¥æˆ–ä¸­æ–­';
                            }
                            
                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                            
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            setTimeout(() => {
                                startBtn.style.display = 'inline-block';
                                startBtn.disabled = false;
                                startBtn.innerHTML = 'å¯åŠ¨æ‰¹é‡è®­ç»ƒ';
                                stopBtn.style.display = 'none';
                                stopBtn.disabled = false;
                                stopBtn.innerHTML = 'åœæ­¢è®­ç»ƒ';
                                statusIndicator.style.display = 'none';
                            }, 2000);
                        }
                    })
                    .catch(err => {
                        console.error('è·å–æ‰¹é‡è®­ç»ƒè¾“å‡ºå¤±è´¥:', err);
                        // æ˜¾ç¤ºè¿æ¥é”™è¯¯ï¼Œä½†ç»§ç»­è½®è¯¢
                        const currentTime = new Date().toLocaleTimeString();
                        const currentContent = outputDiv.innerHTML;
                        if (!currentContent.includes('è¿æ¥æœåŠ¡å™¨å¤±è´¥')) {
                            outputDiv.innerHTML = currentContent + `\n<span style="color:#f59e0b;">[${currentTime}] è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...</span>\n`;
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                    });
            }, 1000); // æ¯1ç§’è·å–ä¸€æ¬¡è¾“å‡ºï¼Œæ›´åŠæ—¶
        }
        
        // åœæ­¢è½®è¯¢æ‰¹é‡è®­ç»ƒè¾“å‡º
        function stopPollingBatchTrainingOutput() {
            if (batchTrainingInterval) {
                clearInterval(batchTrainingInterval);
                batchTrainingInterval = null;
            }
        }
        
        // é¡µé¢å…³é—­å‰åœæ­¢è½®è¯¢
        window.addEventListener('beforeunload', function() {
            stopPollingBatchTrainingOutput();
        });
    </script>
</body>
</html>
