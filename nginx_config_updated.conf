server {
    listen 8801;
    listen [::]:8801;
    
    # 添加对外网端口的支持
    listen 22683;
    listen [::]:22683;

    # 设置正确的根目录 - 指向你的前端文件所在位置
    root /home/vipuser/frontPageTest;

    # 设置默认首页
    index index.html index.htm;

    server_name sjjatustc.top;

    # 首页和静态HTML文件
    location / {
        try_files $uri $uri/ @flask;
        expires 1h;
        add_header Cache-Control "public";
    }
    
    # 静态资源文件（图片、视频等）
    location /assets/ {
        try_files $uri =404;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # API 路由代理到 Flask - 支持模块化API
    location ~* ^/(upload|upload_status|run_inference|clear_cache|clear_cuda|api|platform_status)(/[^/]+)?$ {
        proxy_pass http://127.0.0.1:8800;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Handle WebSocket connections if needed
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 添加超时设置 - 增加推理任务的超时时间
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;  # 10分钟
        proxy_read_timeout 600s;  # 10分钟
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_max_temp_file_size 1024m;
    }
    
    # 如果静态文件没有找到，则代理到Flask
    location @flask {
        proxy_pass http://127.0.0.1:8800;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
