<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>算法试用 | 视频数据合成</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- GPU监控组件 - 调试版 -->
    <script src="gpu_monitor_debug.js"></script>
    <!-- JSZip库用于打包下载多个视频文件 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', '微软雅黑', Arial, sans-serif;
            background: #f6f8fa;
            color: #23272f;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 40px 40px 40px;
        }
        h1 {
            color: #1769aa;
            font-size: 2rem;
            margin-bottom: 18px;
            font-weight: 700;
        }
        .upload-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 28px;
            font-size: 1.08rem;
            border: none;
            border-radius: 8px;
            background: #1769aa;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #125b8c;
        }
        .result-area {
            margin-top: 24px;
            text-align: center;
            min-height: 120px;
            color: #888;
            font-size: 1.08rem;
        }
        .preview-video {
            max-width: 90%;
            border-radius: 8px;
            margin-top: 12px;
            box-shadow: 0 1px 8px rgba(23,105,170,0.08);
        }
    </style>
</head>
<body>
    <div style="max-width:600px;margin:32px auto 0 auto;text-align:left;">
        <a href="index.html" style="display:inline-block;padding:8px 18px;background:#e3eef7;color:#1769aa;border-radius:6px;text-decoration:none;font-size:1.02rem;font-weight:500;box-shadow:0 1px 6px rgba(23,105,170,0.06);transition:background 0.2s;">← 返回首页</a>
    </div>
    <div class="container">
        <h1>视频去雾生成算法试用 
            <button id="download-dataset-btn" class="upload-btn" style="background:#9c27b0;margin-left:20px;display:inline-block;padding:8px 16px;font-size:0.9rem;">下载推荐数据集</button>
        </h1>
        <div style="color:#1769aa;font-size:1.08rem;margin-bottom:18px;text-align:center;">
            我们推荐您使用我们提供的雾天数据集，点击上方按钮即可下载。<br>
            如果要自行使用雾天视频请使用MP4格式。
        </div>
        <input type="file" id="video-upload" accept="video/*" multiple class="upload-btn" style="margin-bottom:12px;">
        <button id="upload-btn" class="upload-btn" style="background:#28a745;margin-bottom:24px;" disabled>上传视频到服务器</button>
        <div class="result-area" id="result-area">请选择一个或多个视频文件，然后点击上传按钮。</div>
        <button id="clear-cache-btn" class="upload-btn" style="background:#e57373;margin-bottom:18px;">清除缓存</button>
        <button id="run-infer-btn" class="upload-btn" style="background:#ff9800;margin-bottom:18px;">执行视频处理脚本</button>
        <button id="download-results-btn" class="upload-btn" style="background:#4caf50;margin-bottom:18px;display:none;">保存输出视频到本地</button>
        <button id="download-all-btn" class="upload-btn" style="background:#1769aa;margin-bottom:18px;display:none;">下载视频+图片帧</button>
        <div id="infer-result" class="result-area"></div>
        <div style="text-align:center;color:#888;font-size:1.02rem;margin-top:38px;">
            前后端技术支持：施钧舰
        </div>
    </div>
    <script>
        // 清除缓存按钮事件
        document.getElementById('clear-cache-btn').onclick = function() {
            const inferResult = document.getElementById('infer-result');
            inferResult.innerHTML = '';
            result.innerHTML = '正在清除缓存...';
            // 隐藏下载按钮并清空结果数据
            downloadBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            currentResultVideos = [];
            
            fetch('/clear_cache/video', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        result.innerHTML = `<div style="color:#1769aa;">${data.message}</div>`;
                    } else {
                        result.innerHTML = `<div style="color:red;">${data.error || '清除缓存失败'}</div>`;
                    }
                    // 清空本地状态
                    selectedFiles = [];
                    uploadBtn.disabled = true;
                    uploadBtn.style.background = '#ccc';
                })
                .catch(err => {
                    result.innerHTML = `<div style="color:red;">清除缓存失败：${err}</div>`;
                });
        };
        
        const upload = document.getElementById('video-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const result = document.getElementById('result-area');
        const downloadBtn = document.getElementById('download-results-btn');
        const downloadDatasetBtn = document.getElementById('download-dataset-btn');
        let selectedFiles = [];
        let currentResultVideos = []; // 存储当前处理结果的视频数据

        // 数据集下载按钮事件
        downloadDatasetBtn.onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '正在准备数据集...';
            
            // 添加时间戳参数避免缓存
            const timestamp = new Date().getTime();
            fetch(`/download_dataset/video?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('数据集下载失败');
                    
                    // 从响应头中获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'video_dataset.zip'; // 默认文件名
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    alert('数据集下载失败: ' + err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '下载推荐数据集';
                });
        };

        // 页面加载时检测上传状态
        window.onload = function() {
            fetch('/upload_status/video')
                .then(res => res.json())
                .then(data => {
                    if (data.has_files) {
                        const fileCount = data.total_files;
                        const latestFile = data.latest_filename;
                        result.innerHTML = `已上传${fileCount}个视频文件，最新：${latestFile}，上传时间：${data.latest_upload_time}`;
                    } else {
                        result.innerHTML = '请选择一个或多个视频文件，然后点击上传按钮。';
                    }
                })
                .catch(err => {
                    result.innerHTML = '请选择一个或多个视频文件，然后点击上传按钮。';
                });
        };

        // 文件选择事件（购物车式追加）
        upload.onchange = function(e) {
            const newFiles = Array.from(e.target.files);
            // 追加新文件，避免重复（按文件名和大小去重）
            newFiles.forEach(newFile => {
                if (!selectedFiles.some(f => f.name === newFile.name && f.size === newFile.size)) {
                    selectedFiles.push(newFile);
                }
            });
            if (selectedFiles.length > 0) {
                let previewHtml = `<div style=\"margin-bottom:15px;\">已选择 ${selectedFiles.length} 个视频文件：</div>`;
                let cardsHtml = '';
                selectedFiles.forEach((file, index) => {
                    // 获取文件扩展名
                    const fileExtension = file.name.split('.').pop().toUpperCase();
                    cardsHtml += `
                        <div style="margin:8px;display:inline-block;text-align:center;border:1px solid #ddd;border-radius:8px;padding:12px;min-width:120px;background:#f9f9f9;">
                            <div style="font-size:2rem;color:#1769aa;margin-bottom:8px;">📹</div>
                            <div style="font-size:0.9rem;color:#333;margin-bottom:4px;word-break:break-word;max-width:150px;">${file.name}</div>
                            <div style="font-size:0.8rem;color:#666;background:#e3eef7;padding:2px 6px;border-radius:4px;display:inline-block;">${fileExtension}</div>
                            <div style="font-size:0.8rem;color:#999;margin-top:4px;">${(file.size / (1024*1024)).toFixed(1)} MB</div>
                        </div>
                    `;
                });
                result.innerHTML = previewHtml + cardsHtml;
                uploadBtn.disabled = false;
                uploadBtn.style.background = '#28a745';
            } else {
                result.innerHTML = '请选择一个或多个视频文件，然后点击上传按钮。';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
            }
        };

        // 上传按钮点击事件（批量上传）
        uploadBtn.onclick = function() {
            if (selectedFiles.length === 0) return;
            result.innerHTML = `<div style=\"color:#1769aa;\">正在上传 ${selectedFiles.length} 个视频文件到服务器...</div>`;
            uploadBtn.disabled = true;
            uploadBtn.style.background = '#ccc';
            let uploadCount = 0;
            let successCount = 0;
            let results = [];
            selectedFiles.forEach((file, index) => {
                const formData = new FormData();
                formData.append('file', file);
                fetch('/upload/video', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    uploadCount++;
                    if (data.msg) {
                        successCount++;
                        results.push(`✓ ${file.name}: ${data.msg}`);
                    } else {
                        results.push(`✗ ${file.name}: ${data.error || '上传失败'}`);
                    }
                    result.innerHTML = `<div style=\"color:#1769aa;\">上传进度: ${uploadCount}/${selectedFiles.length}</div>`;
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style=\"color:#1769aa;margin-bottom:10px;\">上传完成！成功: ${successCount}/${selectedFiles.length}</div>
                            <div style=\"text-align:left;font-size:0.9rem;\">${results.join('<br>')}</div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                    }
                })
                .catch(err => {
                    uploadCount++;
                    results.push(`✗ ${file.name}: ${err}`);
                    result.innerHTML = `<div style=\"color:#1769aa;\">上传进度: ${uploadCount}/${selectedFiles.length}</div>`;
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style=\"color:#1769aa;margin-bottom:10px;\">上传完成！成功: ${successCount}/${selectedFiles.length}</div>
                            <div style=\"text-align:left;font-size:0.9rem;\">${results.join('<br>')}</div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                    }
                });
            });
        };
        
        // 执行视频处理脚本按钮事件
        const downloadAllBtn = document.getElementById('download-all-btn');
        document.getElementById('run-infer-btn').onclick = function() {
            const inferResult = document.getElementById('infer-result');
            inferResult.innerHTML = '正在执行视频处理脚本，请耐心等待...';
            // 隐藏下载按钮
            downloadBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            currentResultVideos = [];
            
            fetch('/run_inference/video', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    let html = '';
                    if (data.output) {
                        html += `<div style=\"color:#1769aa;\">处理结果：<pre style=\"white-space:pre-wrap;\">${data.output}</pre></div>`;
                    }
                    if (data.result_files && data.result_files.length > 0) {
                        // 存储结果视频数据
                        currentResultVideos = data.result_files;
                        
                        // 创建左右对比的视频展示
                        html += '<div style=\"margin-top:20px;\"><h3 style=\"color:#333;text-align:center;\">视频处理对比结果</h3></div>';
                        
                        // 为每个输出视频创建对比界面
                        data.result_files.forEach((outputVideo, index) => {
                            html += `
                                <div style="margin:20px 0;border:1px solid #ddd;border-radius:12px;padding:20px;background:#f9f9f9;">
                                    <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                                        <div style="flex:1;min-width:300px;max-width:45%;">
                                            <h4 style="color:#1769aa;text-align:center;margin-bottom:15px;">📥 输入视频 (Input)</h4>
                                            <div style="text-align:center;border:2px solid #1769aa;border-radius:8px;padding:15px;background:#fff;">
                                                <div id="input-container-${index}" style="min-height:200px;">
                                                    <div style="color:#666;padding:80px 20px;">正在加载输入视频...</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="flex:1;min-width:300px;max-width:45%;">
                                            <h4 style="color:#28a745;text-align:center;margin-bottom:15px;">📤 输出视频 (Output)</h4>
                                            <div style="text-align:center;border:2px solid #28a745;border-radius:8px;padding:15px;background:#fff;">
                                                <div id="output-container-${index}" style="min-height:200px;">
                                                    <div style="color:#666;padding:80px 20px;">正在加载输出视频...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        // 显示下载按钮
                        downloadBtn.style.display = 'block';
                        downloadAllBtn.style.display = 'block';
                        
                        // 加载输入和输出视频（使用转换后的格式）
                        setTimeout(() => {
                            loadInputVideosForComparison(data.result_files);
                            loadOutputVideosForComparison(data.result_files);
                        }, 100);
                    }
                    // 显示处理消息
                    if (data.message) {
                        html += `<div style="color:#1769aa;margin-top:10px;">${data.message}</div>`;
                    }
                    inferResult.innerHTML = html;
                })
                .catch(err => {
                    // 不显示前端请求失败信息
                    inferResult.innerHTML = '';
                    downloadBtn.style.display = 'none';
                    downloadAllBtn.style.display = 'none';
                    currentResultVideos = [];
                });
        };

        // 下载单个视频文件（直接下载静态文件）
        function downloadVideoFile(filename) {
            console.log('尝试下载文件:', filename);
            
            // 创建一个临时的测试链接，检查文件是否可访问
            fetch('/result/videos/' + filename, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('文件可访问，开始下载');
                        const a = document.createElement('a');
                        a.href = '/result/videos/' + filename;
                        a.download = filename;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                        }, 100);
                    } else {
                        console.error('文件不可访问:', response.status);
                        alert('文件下载失败：' + response.status);
                    }
                })
                .catch(err => {
                    console.error('下载检查失败:', err);
                    alert('文件下载失败，请重试');
                });
        }

        // 下载结果视频按钮事件
        document.getElementById('download-results-btn').onclick = function() {
            if (currentResultVideos.length === 0) {
                alert('没有可下载的视频文件');
                return;
            }
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '正在准备下载...';
            try {
                if (currentResultVideos.length === 1) {
                    downloadVideoFile(currentResultVideos[0].filename);
                } else {
                    // 多个视频文件逐个下载
                    downloadVideosSequentially(currentResultVideos);
                }
            } catch (error) {
                alert('下载失败，请重试');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '保存输出视频到本地';
            }
        };

        // 下载全部内容按钮事件（zip整个output文件夹）
        document.getElementById('download-all-btn').onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '正在打包...';
            
            // 添加时间戳参数避免缓存
            const timestamp = new Date().getTime();
            fetch(`/download_all_result/video?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('下载失败');
                    
                    // 从响应头中获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'video_results.zip'; // 默认文件名
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    alert('下载失败: ' + err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '下载视频+图片帧';
                });
        };

        // 逐个下载视频文件（使用静态文件路径）
        function downloadVideosSequentially(videos) {
            videos.forEach((video, index) => {
                setTimeout(() => {
                    const filename = video.filename;
                    downloadVideoFile(filename);
                }, index * 500); // 每0.5秒下载一个，避免浏览器阻止
            });
        }

        // 加载输入视频用于对比显示（使用转换后的格式）
        function loadInputVideosForComparison(outputVideos) {
            // 首先获取所有输入视频列表
            fetch('/list_input_videos')
                .then(res => res.json())
                .then(inputData => {
                    if (inputData.error) {
                        console.error('获取输入视频列表失败:', inputData.error);
                        outputVideos.forEach((outputVideo, index) => {
                            const container = document.getElementById(`input-container-${index}`);
                            if (container) {
                                container.innerHTML = `
                                    <div style="color:#dc3545;padding:80px 20px;">
                                        <div>获取输入视频列表失败</div>
                                        <div style="font-size:0.8rem;margin-top:5px;">${inputData.error}</div>
                                    </div>
                                `;
                            }
                        });
                        return;
                    }
                    
                    const inputVideos = inputData.videos || [];
                    
                    // 为每个输出视频匹配对应的输入视频
                    outputVideos.forEach((outputVideo, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (!container) return;
                        
                        // 显示加载状态
                        container.innerHTML = `
                            <div style="color:#1769aa;padding:80px 20px;">
                                <div style="font-size:1.2rem;margin-bottom:10px;">🔄</div>
                                <div>正在转换视频格式...</div>
                            </div>
                        `;
                        
                        // 尝试通过文件名匹配找到对应的输入视频
                        const baseName = outputVideo.filename.replace(/(_processed|_result|_output)?\.(mp4|avi|mov|mkv)$/i, '');
                        
                        // 寻找最匹配的输入视频
                        let matchedInput = inputVideos.find(input => {
                            const inputBaseName = input.filename.replace(/\.(mp4|avi|mov|mkv)$/i, '');
                            return inputBaseName === baseName || input.filename.includes(baseName) || baseName.includes(inputBaseName);
                        });
                        
                        // 如果没有找到匹配的，使用第一个输入视频
                        if (!matchedInput && inputVideos.length > 0) {
                            matchedInput = inputVideos[0];
                        }
                        
                        if (matchedInput) {
                            // 使用转换API来获取兼容格式的视频
                            fetch(`/convert_video/${matchedInput.filename}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`转换失败: ${response.status}`);
                                    }
                                    return response.blob();
                                })
                                .then(blob => {
                                    // 创建blob URL
                                    const videoUrl = URL.createObjectURL(blob);
                                    
                                    container.innerHTML = `
                                        <video src="${videoUrl}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                            您的浏览器不支持视频播放
                                        </video>
                                        <div style="font-size:0.9rem;color:#333;margin-top:8px;">${matchedInput.filename}</div>
                                        <div style="font-size:0.8rem;color:#999;">原始视频 (${matchedInput.size_mb} MB) - 已转换</div>
                                    `;
                                })
                                .catch(err => {
                                    console.error('转换输入视频失败:', err);
                                    container.innerHTML = `
                                        <div style="color:#dc3545;padding:80px 20px;">
                                            <div style="font-size:2rem;margin-bottom:10px;">⚠️</div>
                                            <div>视频转换失败</div>
                                            <div style="font-size:0.8rem;margin-top:5px;">${err.message}</div>
                                            <div style="font-size:0.8rem;margin-top:10px;">
                                                原文件: ${matchedInput.filename}
                                            </div>
                                        </div>
                                    `;
                                });
                        } else {
                            container.innerHTML = `
                                <div style="color:#999;padding:80px 20px;">
                                    <div style="font-size:3rem;margin-bottom:10px;">📹</div>
                                    <div>未找到对应的输入视频</div>
                                </div>
                            `;
                        }
                    });
                })
                .catch(err => {
                    console.error('加载输入视频失败:', err);
                    // 显示错误信息
                    outputVideos.forEach((outputVideo, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (container) {
                            container.innerHTML = `
                                <div style="color:#dc3545;padding:80px 20px;">
                                    <div>加载输入视频失败</div>
                                    <div style="font-size:0.8rem;margin-top:5px;">${err}</div>
                                </div>
                            `;
                        }
                    });
                });
        }

        // 加载输出视频用于对比显示（使用转换后的格式）
        function loadOutputVideosForComparison(outputVideos) {
            outputVideos.forEach((outputVideo, index) => {
                const container = document.getElementById(`output-container-${index}`);
                if (!container) return;
                
                // 显示加载状态
                container.innerHTML = `
                    <div style="color:#28a745;padding:80px 20px;">
                        <div style="font-size:1.2rem;margin-bottom:10px;">🔄</div>
                        <div>正在转换输出视频格式...</div>
                    </div>
                `;
                
                // 使用转换API来获取兼容格式的输出视频
                fetch(`/convert_output_video/${outputVideo.filename}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`转换失败: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // 创建blob URL
                        const videoUrl = URL.createObjectURL(blob);
                        
                        container.innerHTML = `
                            <video src="${videoUrl}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                您的浏览器不支持视频播放
                            </video>
                            <div style="font-size:0.9rem;color:#333;margin-top:8px;">${outputVideo.filename}</div>
                            <div style="font-size:0.8rem;color:#999;">处理后的视频 - 已转换</div>
                        `;
                    })
                    .catch(err => {
                        console.error('转换输出视频失败:', err);
                        container.innerHTML = `
                            <div style="color:#dc3545;padding:80px 20px;">
                                <div style="font-size:2rem;margin-bottom:10px;">⚠️</div>
                                <div>输出视频转换失败</div>
                                <div style="font-size:0.8rem;margin-top:5px;">${err.message}</div>
                                <div style="font-size:0.8rem;margin-top:10px;">
                                    尝试直接播放原文件...
                                </div>
                            </div>
                        `;
                        
                        // 如果转换失败，尝试直接播放原文件
                        setTimeout(() => {
                            container.innerHTML = `
                                <video src="/result/videos/${outputVideo.filename}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                    您的浏览器不支持视频播放
                                </video>
                                <div style="font-size:0.9rem;color:#333;margin-top:8px;">${outputVideo.filename}</div>
                                <div style="font-size:0.8rem;color:#999;">处理后的视频 (原格式)</div>
                            `;
                        }, 2000);
                    });
            });
        }
    </script>
</body>
</html>
