<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•è¯•ç”¨ | è§†é¢‘æ•°æ®åˆæˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- GPUç›‘æ§ç»„ä»¶ - è°ƒè¯•ç‰ˆ -->
    <script src="gpu_monitor_debug.js"></script>
    <!-- JSZipåº“ç”¨äºæ‰“åŒ…ä¸‹è½½å¤šä¸ªè§†é¢‘æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: #f6f8fa;
            color: #23272f;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 40px 40px 40px;
        }
        h1 {
            color: #1769aa;
            font-size: 2rem;
            margin-bottom: 18px;
            font-weight: 700;
        }
        .upload-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 28px;
            font-size: 1.08rem;
            border: none;
            border-radius: 8px;
            background: #1769aa;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #125b8c;
        }
        .result-area {
            margin-top: 24px;
            text-align: center;
            min-height: 120px;
            color: #888;
            font-size: 1.08rem;
        }
        .preview-video {
            max-width: 90%;
            border-radius: 8px;
            margin-top: 12px;
            box-shadow: 0 1px 8px rgba(23,105,170,0.08);
        }
    </style>
</head>
<body>
    <div style="max-width:600px;margin:32px auto 0 auto;text-align:left;">
        <a href="index.html" style="display:inline-block;padding:8px 18px;background:#e3eef7;color:#1769aa;border-radius:6px;text-decoration:none;font-size:1.02rem;font-weight:500;box-shadow:0 1px 6px rgba(23,105,170,0.06);transition:background 0.2s;">â† è¿”å›é¦–é¡µ</a>
    </div>
    <div class="container">
        <h1>è§†é¢‘å»é›¾ç”Ÿæˆç®—æ³•è¯•ç”¨ 
            <button id="download-dataset-btn" class="upload-btn" style="background:#9c27b0;margin-left:20px;display:inline-block;padding:8px 16px;font-size:0.9rem;">ä¸‹è½½æ¨èæ•°æ®é›†</button>
        </h1>
        <div style="color:#1769aa;font-size:1.08rem;margin-bottom:18px;text-align:center;">
            æˆ‘ä»¬æ¨èæ‚¨ä½¿ç”¨æˆ‘ä»¬æä¾›çš„é›¾å¤©æ•°æ®é›†ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å³å¯ä¸‹è½½ã€‚<br>
            å¦‚æœè¦è‡ªè¡Œä½¿ç”¨é›¾å¤©è§†é¢‘è¯·ä½¿ç”¨MP4æ ¼å¼ã€‚
        </div>
        <input type="file" id="video-upload" accept="video/*" multiple class="upload-btn" style="margin-bottom:12px;">
        <button id="upload-btn" class="upload-btn" style="background:#28a745;margin-bottom:24px;" disabled>ä¸Šä¼ è§†é¢‘åˆ°æœåŠ¡å™¨</button>
        <div class="result-area" id="result-area">è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§†é¢‘æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚</div>
        <button id="clear-cache-btn" class="upload-btn" style="background:#e57373;margin-bottom:18px;">æ¸…é™¤ç¼“å­˜</button>
        <button id="run-infer-btn" class="upload-btn" style="background:#ff9800;margin-bottom:18px;">æ‰§è¡Œè§†é¢‘å¤„ç†è„šæœ¬</button>
        <button id="download-results-btn" class="upload-btn" style="background:#4caf50;margin-bottom:18px;display:none;">ä¿å­˜è¾“å‡ºè§†é¢‘åˆ°æœ¬åœ°</button>
        <button id="download-all-btn" class="upload-btn" style="background:#1769aa;margin-bottom:18px;display:none;">ä¸‹è½½è§†é¢‘+å›¾ç‰‡å¸§</button>
        <div id="infer-result" class="result-area"></div>
        <div style="text-align:center;color:#888;font-size:1.02rem;margin-top:38px;">
            å‰åç«¯æŠ€æœ¯æ”¯æŒï¼šæ–½é’§èˆ°
        </div>
    </div>
    <script>
        // æ¸…é™¤ç¼“å­˜æŒ‰é’®äº‹ä»¶
        document.getElementById('clear-cache-btn').onclick = function() {
            const inferResult = document.getElementById('infer-result');
            inferResult.innerHTML = '';
            result.innerHTML = 'æ­£åœ¨æ¸…é™¤ç¼“å­˜...';
            // éšè—ä¸‹è½½æŒ‰é’®å¹¶æ¸…ç©ºç»“æœæ•°æ®
            downloadBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            currentResultVideos = [];
            
            fetch('/clear_cache/video', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        result.innerHTML = `<div style="color:#1769aa;">${data.message}</div>`;
                    } else {
                        result.innerHTML = `<div style="color:red;">${data.error || 'æ¸…é™¤ç¼“å­˜å¤±è´¥'}</div>`;
                    }
                    // æ¸…ç©ºæœ¬åœ°çŠ¶æ€
                    selectedFiles = [];
                    uploadBtn.disabled = true;
                    uploadBtn.style.background = '#ccc';
                })
                .catch(err => {
                    result.innerHTML = `<div style="color:red;">æ¸…é™¤ç¼“å­˜å¤±è´¥ï¼š${err}</div>`;
                });
        };
        
        const upload = document.getElementById('video-upload');
        const uploadBtn = document.getElementById('upload-btn');
        const result = document.getElementById('result-area');
        const downloadBtn = document.getElementById('download-results-btn');
        const downloadDatasetBtn = document.getElementById('download-dataset-btn');
        let selectedFiles = [];
        let currentResultVideos = []; // å­˜å‚¨å½“å‰å¤„ç†ç»“æœçš„è§†é¢‘æ•°æ®

        // æ•°æ®é›†ä¸‹è½½æŒ‰é’®äº‹ä»¶
        downloadDatasetBtn.onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'æ­£åœ¨å‡†å¤‡æ•°æ®é›†...';
            
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            fetch(`/download_dataset/video?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('æ•°æ®é›†ä¸‹è½½å¤±è´¥');
                    
                    // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'video_dataset.zip'; // é»˜è®¤æ–‡ä»¶å
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    alert('æ•°æ®é›†ä¸‹è½½å¤±è´¥: ' + err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¸‹è½½æ¨èæ•°æ®é›†';
                });
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æµ‹ä¸Šä¼ çŠ¶æ€
        window.onload = function() {
            fetch('/upload_status/video')
                .then(res => res.json())
                .then(data => {
                    if (data.has_files) {
                        const fileCount = data.total_files;
                        const latestFile = data.latest_filename;
                        result.innerHTML = `å·²ä¸Šä¼ ${fileCount}ä¸ªè§†é¢‘æ–‡ä»¶ï¼Œæœ€æ–°ï¼š${latestFile}ï¼Œä¸Šä¼ æ—¶é—´ï¼š${data.latest_upload_time}`;
                    } else {
                        result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§†é¢‘æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                    }
                })
                .catch(err => {
                    result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§†é¢‘æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                });
        };

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼ˆè´­ç‰©è½¦å¼è¿½åŠ ï¼‰
        upload.onchange = function(e) {
            const newFiles = Array.from(e.target.files);
            // è¿½åŠ æ–°æ–‡ä»¶ï¼Œé¿å…é‡å¤ï¼ˆæŒ‰æ–‡ä»¶åå’Œå¤§å°å»é‡ï¼‰
            newFiles.forEach(newFile => {
                if (!selectedFiles.some(f => f.name === newFile.name && f.size === newFile.size)) {
                    selectedFiles.push(newFile);
                }
            });
            if (selectedFiles.length > 0) {
                let previewHtml = `<div style=\"margin-bottom:15px;\">å·²é€‰æ‹© ${selectedFiles.length} ä¸ªè§†é¢‘æ–‡ä»¶ï¼š</div>`;
                let cardsHtml = '';
                selectedFiles.forEach((file, index) => {
                    // è·å–æ–‡ä»¶æ‰©å±•å
                    const fileExtension = file.name.split('.').pop().toUpperCase();
                    cardsHtml += `
                        <div style="margin:8px;display:inline-block;text-align:center;border:1px solid #ddd;border-radius:8px;padding:12px;min-width:120px;background:#f9f9f9;">
                            <div style="font-size:2rem;color:#1769aa;margin-bottom:8px;">ğŸ“¹</div>
                            <div style="font-size:0.9rem;color:#333;margin-bottom:4px;word-break:break-word;max-width:150px;">${file.name}</div>
                            <div style="font-size:0.8rem;color:#666;background:#e3eef7;padding:2px 6px;border-radius:4px;display:inline-block;">${fileExtension}</div>
                            <div style="font-size:0.8rem;color:#999;margin-top:4px;">${(file.size / (1024*1024)).toFixed(1)} MB</div>
                        </div>
                    `;
                });
                result.innerHTML = previewHtml + cardsHtml;
                uploadBtn.disabled = false;
                uploadBtn.style.background = '#28a745';
            } else {
                result.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªè§†é¢‘æ–‡ä»¶ï¼Œç„¶åç‚¹å‡»ä¸Šä¼ æŒ‰é’®ã€‚';
                uploadBtn.disabled = true;
                uploadBtn.style.background = '#ccc';
            }
        };

        // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆæ‰¹é‡ä¸Šä¼ ï¼‰
        uploadBtn.onclick = function() {
            if (selectedFiles.length === 0) return;
            result.innerHTML = `<div style=\"color:#1769aa;\">æ­£åœ¨ä¸Šä¼  ${selectedFiles.length} ä¸ªè§†é¢‘æ–‡ä»¶åˆ°æœåŠ¡å™¨...</div>`;
            uploadBtn.disabled = true;
            uploadBtn.style.background = '#ccc';
            let uploadCount = 0;
            let successCount = 0;
            let results = [];
            selectedFiles.forEach((file, index) => {
                const formData = new FormData();
                formData.append('file', file);
                fetch('/upload/video', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    uploadCount++;
                    if (data.msg) {
                        successCount++;
                        results.push(`âœ“ ${file.name}: ${data.msg}`);
                    } else {
                        results.push(`âœ— ${file.name}: ${data.error || 'ä¸Šä¼ å¤±è´¥'}`);
                    }
                    result.innerHTML = `<div style=\"color:#1769aa;\">ä¸Šä¼ è¿›åº¦: ${uploadCount}/${selectedFiles.length}</div>`;
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style=\"color:#1769aa;margin-bottom:10px;\">ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}/${selectedFiles.length}</div>
                            <div style=\"text-align:left;font-size:0.9rem;\">${results.join('<br>')}</div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                    }
                })
                .catch(err => {
                    uploadCount++;
                    results.push(`âœ— ${file.name}: ${err}`);
                    result.innerHTML = `<div style=\"color:#1769aa;\">ä¸Šä¼ è¿›åº¦: ${uploadCount}/${selectedFiles.length}</div>`;
                    if (uploadCount === selectedFiles.length) {
                        result.innerHTML = `
                            <div style=\"color:#1769aa;margin-bottom:10px;\">ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}/${selectedFiles.length}</div>
                            <div style=\"text-align:left;font-size:0.9rem;\">${results.join('<br>')}</div>
                        `;
                        uploadBtn.disabled = false;
                        uploadBtn.style.background = '#28a745';
                        selectedFiles = [];
                    }
                });
            });
        };
        
        // æ‰§è¡Œè§†é¢‘å¤„ç†è„šæœ¬æŒ‰é’®äº‹ä»¶
        const downloadAllBtn = document.getElementById('download-all-btn');
        document.getElementById('run-infer-btn').onclick = function() {
            const inferResult = document.getElementById('infer-result');
            inferResult.innerHTML = 'æ­£åœ¨æ‰§è¡Œè§†é¢‘å¤„ç†è„šæœ¬ï¼Œè¯·è€å¿ƒç­‰å¾…...';
            // éšè—ä¸‹è½½æŒ‰é’®
            downloadBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            currentResultVideos = [];
            
            fetch('/run_inference/video', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    let html = '';
                    if (data.output) {
                        html += `<div style=\"color:#1769aa;\">å¤„ç†ç»“æœï¼š<pre style=\"white-space:pre-wrap;\">${data.output}</pre></div>`;
                    }
                    if (data.result_files && data.result_files.length > 0) {
                        // å­˜å‚¨ç»“æœè§†é¢‘æ•°æ®
                        currentResultVideos = data.result_files;
                        
                        // åˆ›å»ºå·¦å³å¯¹æ¯”çš„è§†é¢‘å±•ç¤º
                        html += '<div style=\"margin-top:20px;\"><h3 style=\"color:#333;text-align:center;\">è§†é¢‘å¤„ç†å¯¹æ¯”ç»“æœ</h3></div>';
                        
                        // ä¸ºæ¯ä¸ªè¾“å‡ºè§†é¢‘åˆ›å»ºå¯¹æ¯”ç•Œé¢
                        data.result_files.forEach((outputVideo, index) => {
                            html += `
                                <div style="margin:20px 0;border:1px solid #ddd;border-radius:12px;padding:20px;background:#f9f9f9;">
                                    <div style="display:flex;gap:20px;justify-content:center;flex-wrap:wrap;">
                                        <div style="flex:1;min-width:300px;max-width:45%;">
                                            <h4 style="color:#1769aa;text-align:center;margin-bottom:15px;">ğŸ“¥ è¾“å…¥è§†é¢‘ (Input)</h4>
                                            <div style="text-align:center;border:2px solid #1769aa;border-radius:8px;padding:15px;background:#fff;">
                                                <div id="input-container-${index}" style="min-height:200px;">
                                                    <div style="color:#666;padding:80px 20px;">æ­£åœ¨åŠ è½½è¾“å…¥è§†é¢‘...</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="flex:1;min-width:300px;max-width:45%;">
                                            <h4 style="color:#28a745;text-align:center;margin-bottom:15px;">ğŸ“¤ è¾“å‡ºè§†é¢‘ (Output)</h4>
                                            <div style="text-align:center;border:2px solid #28a745;border-radius:8px;padding:15px;background:#fff;">
                                                <div id="output-container-${index}" style="min-height:200px;">
                                                    <div style="color:#666;padding:80px 20px;">æ­£åœ¨åŠ è½½è¾“å‡ºè§†é¢‘...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        downloadBtn.style.display = 'block';
                        downloadAllBtn.style.display = 'block';
                        
                        // åŠ è½½è¾“å…¥å’Œè¾“å‡ºè§†é¢‘ï¼ˆä½¿ç”¨è½¬æ¢åçš„æ ¼å¼ï¼‰
                        setTimeout(() => {
                            loadInputVideosForComparison(data.result_files);
                            loadOutputVideosForComparison(data.result_files);
                        }, 100);
                    }
                    // æ˜¾ç¤ºå¤„ç†æ¶ˆæ¯
                    if (data.message) {
                        html += `<div style="color:#1769aa;margin-top:10px;">${data.message}</div>`;
                    }
                    inferResult.innerHTML = html;
                })
                .catch(err => {
                    // ä¸æ˜¾ç¤ºå‰ç«¯è¯·æ±‚å¤±è´¥ä¿¡æ¯
                    inferResult.innerHTML = '';
                    downloadBtn.style.display = 'none';
                    downloadAllBtn.style.display = 'none';
                    currentResultVideos = [];
                });
        };

        // ä¸‹è½½å•ä¸ªè§†é¢‘æ–‡ä»¶ï¼ˆç›´æ¥ä¸‹è½½é™æ€æ–‡ä»¶ï¼‰
        function downloadVideoFile(filename) {
            console.log('å°è¯•ä¸‹è½½æ–‡ä»¶:', filename);
            
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æµ‹è¯•é“¾æ¥ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è®¿é—®
            fetch('/result/videos/' + filename, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('æ–‡ä»¶å¯è®¿é—®ï¼Œå¼€å§‹ä¸‹è½½');
                        const a = document.createElement('a');
                        a.href = '/result/videos/' + filename;
                        a.download = filename;
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        setTimeout(() => {
                            document.body.removeChild(a);
                        }, 100);
                    } else {
                        console.error('æ–‡ä»¶ä¸å¯è®¿é—®:', response.status);
                        alert('æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼š' + response.status);
                    }
                })
                .catch(err => {
                    console.error('ä¸‹è½½æ£€æŸ¥å¤±è´¥:', err);
                    alert('æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
        }

        // ä¸‹è½½ç»“æœè§†é¢‘æŒ‰é’®äº‹ä»¶
        document.getElementById('download-results-btn').onclick = function() {
            if (currentResultVideos.length === 0) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„è§†é¢‘æ–‡ä»¶');
                return;
            }
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = 'æ­£åœ¨å‡†å¤‡ä¸‹è½½...';
            try {
                if (currentResultVideos.length === 1) {
                    downloadVideoFile(currentResultVideos[0].filename);
                } else {
                    // å¤šä¸ªè§†é¢‘æ–‡ä»¶é€ä¸ªä¸‹è½½
                    downloadVideosSequentially(currentResultVideos);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = 'ä¿å­˜è¾“å‡ºè§†é¢‘åˆ°æœ¬åœ°';
            }
        };

        // ä¸‹è½½å…¨éƒ¨å†…å®¹æŒ‰é’®äº‹ä»¶ï¼ˆzipæ•´ä¸ªoutputæ–‡ä»¶å¤¹ï¼‰
        document.getElementById('download-all-btn').onclick = function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'æ­£åœ¨æ‰“åŒ…...';
            
            // æ·»åŠ æ—¶é—´æˆ³å‚æ•°é¿å…ç¼“å­˜
            const timestamp = new Date().getTime();
            fetch(`/download_all_result/video?t=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
                    
                    // ä»å“åº”å¤´ä¸­è·å–æ–‡ä»¶å
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'video_results.zip'; // é»˜è®¤æ–‡ä»¶å
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, '');
                        }
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(err => {
                    alert('ä¸‹è½½å¤±è´¥: ' + err);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'ä¸‹è½½è§†é¢‘+å›¾ç‰‡å¸§';
                });
        };

        // é€ä¸ªä¸‹è½½è§†é¢‘æ–‡ä»¶ï¼ˆä½¿ç”¨é™æ€æ–‡ä»¶è·¯å¾„ï¼‰
        function downloadVideosSequentially(videos) {
            videos.forEach((video, index) => {
                setTimeout(() => {
                    const filename = video.filename;
                    downloadVideoFile(filename);
                }, index * 500); // æ¯0.5ç§’ä¸‹è½½ä¸€ä¸ªï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
            });
        }

        // åŠ è½½è¾“å…¥è§†é¢‘ç”¨äºå¯¹æ¯”æ˜¾ç¤ºï¼ˆä½¿ç”¨è½¬æ¢åçš„æ ¼å¼ï¼‰
        function loadInputVideosForComparison(outputVideos) {
            // é¦–å…ˆè·å–æ‰€æœ‰è¾“å…¥è§†é¢‘åˆ—è¡¨
            fetch('/list_input_videos')
                .then(res => res.json())
                .then(inputData => {
                    if (inputData.error) {
                        console.error('è·å–è¾“å…¥è§†é¢‘åˆ—è¡¨å¤±è´¥:', inputData.error);
                        outputVideos.forEach((outputVideo, index) => {
                            const container = document.getElementById(`input-container-${index}`);
                            if (container) {
                                container.innerHTML = `
                                    <div style="color:#dc3545;padding:80px 20px;">
                                        <div>è·å–è¾“å…¥è§†é¢‘åˆ—è¡¨å¤±è´¥</div>
                                        <div style="font-size:0.8rem;margin-top:5px;">${inputData.error}</div>
                                    </div>
                                `;
                            }
                        });
                        return;
                    }
                    
                    const inputVideos = inputData.videos || [];
                    
                    // ä¸ºæ¯ä¸ªè¾“å‡ºè§†é¢‘åŒ¹é…å¯¹åº”çš„è¾“å…¥è§†é¢‘
                    outputVideos.forEach((outputVideo, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (!container) return;
                        
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        container.innerHTML = `
                            <div style="color:#1769aa;padding:80px 20px;">
                                <div style="font-size:1.2rem;margin-bottom:10px;">ğŸ”„</div>
                                <div>æ­£åœ¨è½¬æ¢è§†é¢‘æ ¼å¼...</div>
                            </div>
                        `;
                        
                        // å°è¯•é€šè¿‡æ–‡ä»¶ååŒ¹é…æ‰¾åˆ°å¯¹åº”çš„è¾“å…¥è§†é¢‘
                        const baseName = outputVideo.filename.replace(/(_processed|_result|_output)?\.(mp4|avi|mov|mkv)$/i, '');
                        
                        // å¯»æ‰¾æœ€åŒ¹é…çš„è¾“å…¥è§†é¢‘
                        let matchedInput = inputVideos.find(input => {
                            const inputBaseName = input.filename.replace(/\.(mp4|avi|mov|mkv)$/i, '');
                            return inputBaseName === baseName || input.filename.includes(baseName) || baseName.includes(inputBaseName);
                        });
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªè¾“å…¥è§†é¢‘
                        if (!matchedInput && inputVideos.length > 0) {
                            matchedInput = inputVideos[0];
                        }
                        
                        if (matchedInput) {
                            // ä½¿ç”¨è½¬æ¢APIæ¥è·å–å…¼å®¹æ ¼å¼çš„è§†é¢‘
                            fetch(`/convert_video/${matchedInput.filename}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`è½¬æ¢å¤±è´¥: ${response.status}`);
                                    }
                                    return response.blob();
                                })
                                .then(blob => {
                                    // åˆ›å»ºblob URL
                                    const videoUrl = URL.createObjectURL(blob);
                                    
                                    container.innerHTML = `
                                        <video src="${videoUrl}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                        </video>
                                        <div style="font-size:0.9rem;color:#333;margin-top:8px;">${matchedInput.filename}</div>
                                        <div style="font-size:0.8rem;color:#999;">åŸå§‹è§†é¢‘ (${matchedInput.size_mb} MB) - å·²è½¬æ¢</div>
                                    `;
                                })
                                .catch(err => {
                                    console.error('è½¬æ¢è¾“å…¥è§†é¢‘å¤±è´¥:', err);
                                    container.innerHTML = `
                                        <div style="color:#dc3545;padding:80px 20px;">
                                            <div style="font-size:2rem;margin-bottom:10px;">âš ï¸</div>
                                            <div>è§†é¢‘è½¬æ¢å¤±è´¥</div>
                                            <div style="font-size:0.8rem;margin-top:5px;">${err.message}</div>
                                            <div style="font-size:0.8rem;margin-top:10px;">
                                                åŸæ–‡ä»¶: ${matchedInput.filename}
                                            </div>
                                        </div>
                                    `;
                                });
                        } else {
                            container.innerHTML = `
                                <div style="color:#999;padding:80px 20px;">
                                    <div style="font-size:3rem;margin-bottom:10px;">ğŸ“¹</div>
                                    <div>æœªæ‰¾åˆ°å¯¹åº”çš„è¾“å…¥è§†é¢‘</div>
                                </div>
                            `;
                        }
                    });
                })
                .catch(err => {
                    console.error('åŠ è½½è¾“å…¥è§†é¢‘å¤±è´¥:', err);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    outputVideos.forEach((outputVideo, index) => {
                        const container = document.getElementById(`input-container-${index}`);
                        if (container) {
                            container.innerHTML = `
                                <div style="color:#dc3545;padding:80px 20px;">
                                    <div>åŠ è½½è¾“å…¥è§†é¢‘å¤±è´¥</div>
                                    <div style="font-size:0.8rem;margin-top:5px;">${err}</div>
                                </div>
                            `;
                        }
                    });
                });
        }

        // åŠ è½½è¾“å‡ºè§†é¢‘ç”¨äºå¯¹æ¯”æ˜¾ç¤ºï¼ˆä½¿ç”¨è½¬æ¢åçš„æ ¼å¼ï¼‰
        function loadOutputVideosForComparison(outputVideos) {
            outputVideos.forEach((outputVideo, index) => {
                const container = document.getElementById(`output-container-${index}`);
                if (!container) return;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                container.innerHTML = `
                    <div style="color:#28a745;padding:80px 20px;">
                        <div style="font-size:1.2rem;margin-bottom:10px;">ğŸ”„</div>
                        <div>æ­£åœ¨è½¬æ¢è¾“å‡ºè§†é¢‘æ ¼å¼...</div>
                    </div>
                `;
                
                // ä½¿ç”¨è½¬æ¢APIæ¥è·å–å…¼å®¹æ ¼å¼çš„è¾“å‡ºè§†é¢‘
                fetch(`/convert_output_video/${outputVideo.filename}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`è½¬æ¢å¤±è´¥: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // åˆ›å»ºblob URL
                        const videoUrl = URL.createObjectURL(blob);
                        
                        container.innerHTML = `
                            <video src="${videoUrl}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                            </video>
                            <div style="font-size:0.9rem;color:#333;margin-top:8px;">${outputVideo.filename}</div>
                            <div style="font-size:0.8rem;color:#999;">å¤„ç†åçš„è§†é¢‘ - å·²è½¬æ¢</div>
                        `;
                    })
                    .catch(err => {
                        console.error('è½¬æ¢è¾“å‡ºè§†é¢‘å¤±è´¥:', err);
                        container.innerHTML = `
                            <div style="color:#dc3545;padding:80px 20px;">
                                <div style="font-size:2rem;margin-bottom:10px;">âš ï¸</div>
                                <div>è¾“å‡ºè§†é¢‘è½¬æ¢å¤±è´¥</div>
                                <div style="font-size:0.8rem;margin-top:5px;">${err.message}</div>
                                <div style="font-size:0.8rem;margin-top:10px;">
                                    å°è¯•ç›´æ¥æ’­æ”¾åŸæ–‡ä»¶...
                                </div>
                            </div>
                        `;
                        
                        // å¦‚æœè½¬æ¢å¤±è´¥ï¼Œå°è¯•ç›´æ¥æ’­æ”¾åŸæ–‡ä»¶
                        setTimeout(() => {
                            container.innerHTML = `
                                <video src="/result/videos/${outputVideo.filename}" style="max-width:100%;max-height:300px;border-radius:8px;" controls muted>
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                </video>
                                <div style="font-size:0.9rem;color:#333;margin-top:8px;">${outputVideo.filename}</div>
                                <div style="font-size:0.8rem;color:#999;">å¤„ç†åçš„è§†é¢‘ (åŸæ ¼å¼)</div>
                            `;
                        }, 2000);
                    });
            });
        }
    </script>
</body>
</html>
