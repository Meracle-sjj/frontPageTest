<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬æ¢æµ‹è¯• | H.264æ ¼å¼è½¬æ¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: #f6f8fa;
            color: #23272f;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 40px 40px 40px;
        }
        h1 {
            color: #1769aa;
            font-size: 2rem;
            margin-bottom: 18px;
            font-weight: 700;
        }
        .btn {
            display: inline-block;
            margin: 8px 12px 8px 0;
            padding: 12px 28px;
            font-size: 1.08rem;
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
        }
        .btn-primary { background: #1769aa; }
        .btn-primary:hover { background: #125b8c; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .video-list {
            margin-top: 24px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }
        .video-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .video-item:last-child {
            border-bottom: none;
        }
        .video-info {
            flex: 1;
        }
        .video-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .video-meta {
            font-size: 0.9rem;
            color: #666;
        }
        .video-actions {
            display: flex;
            gap: 8px;
        }
        .video-preview {
            margin-top: 20px;
            text-align: center;
        }
        .video-preview video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .result-area {
            margin-top: 24px;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #1769aa;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1769aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-info {
            background: #e3f2fd;
            border: 1px solid #1769aa;
            color: #1769aa;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
        }
        .status-success {
            background: #e8f5e8;
            border: 1px solid #28a745;
            color: #28a745;
        }
        .status-error {
            background: #ffeaea;
            border: 1px solid #dc3545;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div style="max-width:900px;margin:32px auto 0 auto;text-align:left;">
        <a href="index.html" style="display:inline-block;padding:8px 18px;background:#e3eef7;color:#1769aa;border-radius:6px;text-decoration:none;font-size:1.02rem;font-weight:500;box-shadow:0 1px 6px rgba(23,105,170,0.06);transition:background 0.2s;">â† è¿”å›é¦–é¡µ</a>
    </div>
    
    <div class="container">
        <h1>è§†é¢‘è½¬æ¢æµ‹è¯• 
            <button id="refresh-btn" class="btn btn-primary" style="font-size:0.9rem;padding:8px 16px;">åˆ·æ–°è§†é¢‘åˆ—è¡¨</button>
        </h1>
        
        <div style="color:#1769aa;font-size:1.08rem;margin-bottom:18px;">
            æ­¤é¡µé¢ç”¨äºæµ‹è¯•å°†ä¸å…¼å®¹çš„MP4è§†é¢‘è½¬æ¢ä¸ºç½‘é¡µå…¼å®¹çš„H.264æ ¼å¼ã€‚
            <br>è½¬æ¢åçš„è§†é¢‘å¯ä»¥åœ¨ç½‘é¡µä¸­æ­£å¸¸æ’­æ”¾ï¼Œæ— éœ€ä¸‹è½½ã€‚
        </div>

        <div class="result-area" id="status-area">
            <div class="status-info">
                æ­£åœ¨åŠ è½½è§†é¢‘åˆ—è¡¨...
            </div>
        </div>

        <div class="video-list" id="video-list" style="display:none;">
            <h3 style="margin-top:0;color:#333;">å¯ç”¨è§†é¢‘æ–‡ä»¶</h3>
            <div id="video-items"></div>
        </div>

        <div class="video-preview" id="video-preview" style="display:none;">
            <h3 style="color:#333;">è§†é¢‘é¢„è§ˆ</h3>
            <div id="preview-content"></div>
        </div>

        <div style="text-align:center;color:#888;font-size:1.02rem;margin-top:38px;">
            è§†é¢‘è½¬æ¢æŠ€æœ¯æµ‹è¯• | å‰åç«¯æŠ€æœ¯æ”¯æŒï¼šæ–½é’§èˆ°
        </div>
    </div>

    <script>
        let currentVideos = [];
        let convertingVideos = new Set(); // è®°å½•æ­£åœ¨è½¬æ¢çš„è§†é¢‘

        // é¡µé¢åŠ è½½æ—¶è·å–è§†é¢‘åˆ—è¡¨
        window.onload = function() {
            loadVideoList();
        };

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶
        document.getElementById('refresh-btn').onclick = function() {
            loadVideoList();
        };

        // åŠ è½½è§†é¢‘åˆ—è¡¨
        function loadVideoList() {
            const statusArea = document.getElementById('status-area');
            const videoList = document.getElementById('video-list');
            
            statusArea.innerHTML = '<div class="status-info"><div class="loading"></div>æ­£åœ¨åŠ è½½è§†é¢‘åˆ—è¡¨...</div>';
            videoList.style.display = 'none';

            fetch('/list_input_videos')
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        statusArea.innerHTML = `<div class="status-error">é”™è¯¯ï¼š${data.error}</div>`;
                        return;
                    }

                    currentVideos = data.videos || [];
                    
                    if (currentVideos.length === 0) {
                        statusArea.innerHTML = '<div class="status-info">è¾“å…¥ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°è§†é¢‘æ–‡ä»¶ã€‚è¯·ç¡®ä¿åœ¨ /home/vipuser/Downloads/MAP-Net/input ç›®å½•ä¸­æ”¾å…¥MP4ç­‰è§†é¢‘æ–‡ä»¶ã€‚</div>';
                        return;
                    }

                    statusArea.innerHTML = `<div class="status-success">æ‰¾åˆ° ${data.count} ä¸ªè§†é¢‘æ–‡ä»¶</div>`;
                    renderVideoList();
                    videoList.style.display = 'block';
                })
                .catch(err => {
                    statusArea.innerHTML = `<div class="status-error">åŠ è½½å¤±è´¥ï¼š${err}</div>`;
                });
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
        function renderVideoList() {
            const videoItems = document.getElementById('video-items');
            
            if (currentVideos.length === 0) {
                videoItems.innerHTML = '<div style="text-align:center;color:#999;">æ²¡æœ‰å¯ç”¨çš„è§†é¢‘æ–‡ä»¶</div>';
                return;
            }

            let html = '';
            currentVideos.forEach((video, index) => {
                const isConverting = convertingVideos.has(video.filename);
                html += `
                    <div class="video-item">
                        <div class="video-info">
                            <div class="video-name">ğŸ“¹ ${video.filename}</div>
                            <div class="video-meta">
                                å¤§å°: ${video.size_mb} MB | ä¿®æ”¹æ—¶é—´: ${video.modified_time}
                            </div>
                        </div>
                        <div class="video-actions">
                            <button class="btn btn-warning" onclick="previewOriginal('${video.filename}')" 
                                    ${isConverting ? 'disabled' : ''}>
                                åŸå§‹é¢„è§ˆ
                            </button>
                            <button class="btn btn-success" onclick="convertAndPreview('${video.filename}')" 
                                    ${isConverting ? 'disabled' : ''}>
                                ${isConverting ? 'è½¬æ¢ä¸­...' : 'è½¬æ¢å¹¶é¢„è§ˆ'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            videoItems.innerHTML = html;
        }

        // é¢„è§ˆåŸå§‹è§†é¢‘ï¼ˆå¯èƒ½æ— æ³•æ’­æ”¾ï¼‰
        function previewOriginal(filename) {
            const previewArea = document.getElementById('video-preview');
            const previewContent = document.getElementById('preview-content');
            
            // å°è¯•ç›´æ¥æ’­æ”¾åŸå§‹æ–‡ä»¶ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
            const originalPath = `/convert_video/${filename}`;
            
            previewContent.innerHTML = `
                <div style="margin-bottom:12px;color:#dc3545;">
                    <strong>åŸå§‹è§†é¢‘é¢„è§ˆï¼ˆå¯èƒ½æ— æ³•æ’­æ”¾ï¼‰ï¼š</strong> ${filename}
                </div>
                <video controls style="max-width:100%;max-height:400px;border-radius:8px;">
                    <source src="/result/videos/${filename}" type="video/mp4">
                    <source src="/convert_video/${filename}" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ï¼Œæˆ–è§†é¢‘æ ¼å¼ä¸å…¼å®¹
                </video>
                <div style="margin-top:12px;color:#666;font-size:0.9rem;">
                    å¦‚æœæ— æ³•æ’­æ”¾ï¼Œè¯´æ˜è§†é¢‘ç¼–ç æ ¼å¼ä¸å…¼å®¹ï¼Œè¯·ç‚¹å‡»"è½¬æ¢å¹¶é¢„è§ˆ"æŒ‰é’®
                </div>
            `;
            
            previewArea.style.display = 'block';
        }

        // è½¬æ¢å¹¶é¢„è§ˆè§†é¢‘
        function convertAndPreview(filename) {
            const previewArea = document.getElementById('video-preview');
            const previewContent = document.getElementById('preview-content');
            
            // æ ‡è®°ä¸ºæ­£åœ¨è½¬æ¢
            convertingVideos.add(filename);
            renderVideoList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ˜¾ç¤ºè½¬æ¢çŠ¶æ€
            
            previewContent.innerHTML = `
                <div style="margin-bottom:12px;color:#1769aa;">
                    <div class="loading"></div>
                    <strong>æ­£åœ¨è½¬æ¢è§†é¢‘ï¼š</strong> ${filename}
                </div>
                <div style="color:#666;font-size:0.9rem;text-align:left;max-width:500px;margin:0 auto;">
                    è½¬æ¢è¿‡ç¨‹è¯´æ˜ï¼š<br>
                    1. ä½¿ç”¨ FFmpeg å°†è§†é¢‘è½¬æ¢ä¸º H.264 + AAC ç¼–ç <br>
                    2. ä¼˜åŒ–ç½‘é¡µæ’­æ”¾æ€§èƒ½ï¼ˆfaststartï¼‰<br>
                    3. è½¬æ¢å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
                </div>
            `;
            previewArea.style.display = 'block';

            // å¼€å§‹è½¬æ¢
            fetch(`/convert_video/${filename}`)
                .then(response => {
                    convertingVideos.delete(filename);
                    renderVideoList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    
                    if (!response.ok) {
                        throw new Error(`è½¬æ¢å¤±è´¥: ${response.status}`);
                    }
                    
                    // è½¬æ¢æˆåŠŸï¼Œè·å–è½¬æ¢åçš„è§†é¢‘blob
                    return response.blob();
                })
                .then(blob => {
                    // åˆ›å»ºblob URL
                    const videoUrl = URL.createObjectURL(blob);
                    
                    previewContent.innerHTML = `
                        <div style="margin-bottom:12px;color:#28a745;">
                            <strong>âœ“ è½¬æ¢æˆåŠŸï¼š</strong> ${filename}
                        </div>
                        <video controls autoplay muted style="max-width:100%;max-height:400px;border-radius:8px;">
                            <source src="${videoUrl}" type="video/mp4">
                            è½¬æ¢åçš„è§†é¢‘æ— æ³•æ’­æ”¾
                        </video>
                        <div style="margin-top:12px;color:#666;font-size:0.9rem;">
                            è½¬æ¢åçš„è§†é¢‘å·²ä¼˜åŒ–ä¸ºç½‘é¡µå…¼å®¹æ ¼å¼ï¼Œå¯ä»¥æ­£å¸¸æ’­æ”¾
                        </div>
                        <div style="margin-top:8px;">
                            <button class="btn btn-primary" onclick="downloadConverted('${videoUrl}', '${filename}')">
                                ä¸‹è½½è½¬æ¢åçš„è§†é¢‘
                            </button>
                        </div>
                    `;
                })
                .catch(err => {
                    convertingVideos.delete(filename);
                    renderVideoList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                    
                    previewContent.innerHTML = `
                        <div style="margin-bottom:12px;color:#dc3545;">
                            <strong>âœ— è½¬æ¢å¤±è´¥ï¼š</strong> ${filename}
                        </div>
                        <div style="color:#dc3545;font-size:0.9rem;">
                            é”™è¯¯ä¿¡æ¯ï¼š${err.message}
                        </div>
                        <div style="margin-top:12px;color:#666;font-size:0.9rem;">
                            å¯èƒ½çš„åŸå› ï¼š<br>
                            â€¢ è§†é¢‘æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ”¯æŒ<br>
                            â€¢ æœåŠ¡å™¨ä¸Šç¼ºå°‘ FFmpeg å·¥å…·<br>
                            â€¢ è½¬æ¢è¿‡ç¨‹è¶…æ—¶ï¼ˆè¶…è¿‡5åˆ†é’Ÿï¼‰
                        </div>
                    `;
                });
        }

        // ä¸‹è½½è½¬æ¢åçš„è§†é¢‘
        function downloadConverted(blobUrl, originalFilename) {
            const a = document.createElement('a');
            a.href = blobUrl;
            const baseName = originalFilename.replace(/\.[^/.]+$/, "");
            a.download = `${baseName}_converted.mp4`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
