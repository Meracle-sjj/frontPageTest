<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•è¯•ç”¨ | æ¿€å…‰é›·è¾¾æ•°æ®ç”Ÿæˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- GPUç›‘æ§ç»„ä»¶ - è°ƒè¯•ç‰ˆ -->
    <script src="gpu_monitor_debug.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: #f6f8fa;
            color: #23272f;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 48px 40px 40px 40px;
        }
        h1 {
            color: #1769aa;
            font-size: 2rem;
            margin-bottom: 18px;
            font-weight: 700;
        }
        .upload-btn {
            display: block;
            margin: 0 auto 24px auto;
            padding: 12px 28px;
            font-size: 1.08rem;
            border: none;
            border-radius: 8px;
            background: #1769aa;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #125b8c;
        }
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result-area {
            margin-top: 24px;
            text-align: center;
            min-height: 120px;
            color: #888;
            font-size: 1.08rem;
        }
        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .parameter-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #1769aa;
        }
        .parameter-name {
            font-weight: 700;
            color: #1769aa;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .parameter-desc {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .output-container {
            margin-top: 30px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 8px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }
        .output-container.active {
            display: block;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-idle {
            background: #ccc;
        }
        .status-running {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }
        .status-success {
            background: #4caf50;
        }
        .status-error {
            background: #f44336;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .info-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #2196f3;
        }
        .info-title {
            color: #1976d2;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        .info-text {
            color: #424242;
            line-height: 1.5;
        }
        
        /* å¯è§†åŒ–ç»“æœæ˜¾ç¤ºæ ·å¼ */
        .results-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .results-container.active {
            display: block;
        }
        
        .results-title {
            text-align: center;
            color: #1769aa;
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .image-pair {
            display: block;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-section {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .image-section:last-child {
            margin-bottom: 0;
        }
        
        .image-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .image-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            margin: 0 auto;
        }
        
        .result-image {
            max-width: 100%;
            max-height: 400px;
            height: auto;
            width: auto;
            display: block;
            object-fit: contain;
        }
        
        .image-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 8px;
        }
        
        .close-results-btn {
            position: sticky;
            top: 10px;
            float: right;
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .close-results-btn:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div style="max-width:800px;margin:32px auto 0 auto;text-align:left;">
        <a href="index.html" style="display:inline-block;padding:8px 18px;background:#e3eef7;color:#1769aa;border-radius:6px;text-decoration:none;font-size:1.02rem;font-weight:500;box-shadow:0 1px 6px rgba(23,105,170,0.06);transition:background 0.2s;">â† è¿”å›é¦–é¡µ</a>
    </div>
    
    <div class="container">
        <h1>æ¿€å…‰é›·è¾¾æ•°æ®ç”Ÿæˆç®—æ³•</h1>
        
        <div class="info-section">
            <div class="info-title">ç®—æ³•ç®€ä»‹</div>
            <div class="info-text">
                æœ¬ç®—æ³•ç”¨äºç”Ÿæˆé«˜è´¨é‡çš„æ¿€å…‰é›·è¾¾ç‚¹äº‘æ•°æ®ï¼Œé‡‡ç”¨å…ˆè¿›çš„æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼Œèƒ½å¤Ÿæ ¹æ®è¾“å…¥å‚æ•°ç”Ÿæˆé€¼çœŸçš„3Dç‚¹äº‘åœºæ™¯ã€‚
                å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…æ‰§è¡Œå®Œæˆã€‚
            </div>
        </div>

        <div class="parameter-grid">
            <div class="parameter-card">
                <div class="parameter-name">Level (å¤šå°ºåº¦çº§åˆ«)</div>
                <div class="parameter-desc">
                    æ§åˆ¶ç”Ÿæˆæ•°æ®çš„ç»†èŠ‚å±‚æ¬¡ï¼Œæ•°å€¼è¶Šé«˜ç”Ÿæˆçš„ç‚¹äº‘ç»†èŠ‚è¶Šä¸°å¯Œï¼Œä½†è®¡ç®—æ—¶é—´ç›¸åº”å¢åŠ ã€‚
                </div>
            </div>
            
            <div class="parameter-card">
                <div class="parameter-name">Step Size (ä¼˜åŒ–æ­¥é•¿)</div>
                <div class="parameter-desc">
                    ä¼˜åŒ–ç®—æ³•çš„æ­¥é•¿å‚æ•°ï¼Œå½±å“æ”¶æ•›é€Ÿåº¦å’Œç²¾åº¦ã€‚è¾ƒå°çš„æ­¥é•¿æä¾›æ›´ç¨³å®šçš„ä¼˜åŒ–è¿‡ç¨‹ã€‚
                </div>
            </div>
            
            <div class="parameter-card">
                <div class="parameter-name">Grad Norm (æ¢¯åº¦L2èŒƒæ•°)</div>
                <div class="parameter-desc">
                    æ¢¯åº¦å‘é‡çš„L2èŒƒæ•°ï¼Œç”¨äºç›‘æ§ä¼˜åŒ–è¿‡ç¨‹çš„ç¨³å®šæ€§å’Œæ”¶æ•›çŠ¶æ€ã€‚
                </div>
            </div>
            
            <div class="parameter-card">
                <div class="parameter-name">Image Norm (å›¾åƒL2èŒƒæ•°)</div>
                <div class="parameter-desc">
                    è¾“å…¥å›¾åƒçš„L2èŒƒæ•°ï¼Œåæ˜ å›¾åƒæ•°æ®çš„å¼ºåº¦åˆ†å¸ƒå’Œè´¨é‡ç‰¹å¾ã€‚
                </div>
            </div>
            
            <div class="parameter-card">
                <div class="parameter-name">SNR (ä¿¡å™ªæ¯”)</div>
                <div class="parameter-desc">
                    ä¿¡å·ä¸å™ªå£°çš„æ¯”å€¼ï¼Œæ•°å€¼è¶Šé«˜è¡¨ç¤ºç”Ÿæˆæ•°æ®çš„è´¨é‡è¶Šå¥½ï¼Œå™ªå£°å¹²æ‰°è¶Šå°ã€‚
                </div>
            </div>
            
            <div class="parameter-card">
                <div class="parameter-name">Grad Mean Norm (æ¢¯åº¦å¹³å‡èŒƒæ•°)</div>
                <div class="parameter-desc">
                    æ¢¯åº¦çš„å¹³å‡èŒƒæ•°å€¼ï¼Œç”¨äºè¯„ä¼°æ•´ä½“ä¼˜åŒ–æ–¹å‘çš„ä¸€è‡´æ€§å’Œç®—æ³•æ”¶æ•›æ€§èƒ½ã€‚
                </div>
            </div>
        </div>

        <!-- æ‰§è¡Œè¯´æ˜æç¤º -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 25px 0; text-align: center;">
            <div style="color: #856404; font-weight: 600; font-size: 1.1rem; margin-bottom: 8px;">
                ç¨‹åºæ‰§è¡Œè¯´æ˜
            </div>
            <div style="color: #856404; font-size: 1rem; line-height: 1.4;">
                åˆæˆæ•°æ®æ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚å½“å¤šå°ºåº¦çº§åˆ«(Level)è¾¾åˆ°220å·¦å³æ—¶ï¼Œåˆæˆæ•°æ®å°†å®Œæˆã€‚</br>
                æ‰§è¡Œå‰è¯·æŒ‰ Ctrl+G æˆ–è€…ç‚¹å‡»å³ä¾§æŒ‰é’®è§‚å¯Ÿå½“å‰GPUèµ„æºï¼Œé¿å…èµ„æºä¸è¶³ã€‚
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <!-- åˆ é™¤ç¼“å­˜æŒ‰é’® -->
            <div style="margin-bottom: 20px;">
                <button id="clear-cache-btn" class="upload-btn" style="background:#ff5722;font-size:1.1rem;padding:12px 30px;">
                    æ¸…é™¤ç¼“å­˜æ–‡ä»¶
                </button>
                <div style="font-size: 0.9rem; color: #666; margin-top: 8px;">
                    æ¸…é™¤ unconditional_samples ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                </div>
            </div>
            
            <!-- æ‰§è¡ŒæŒ‰é’® -->
            <div style="display: inline-block;">
                <button id="run-script-btn" class="upload-btn" style="background:#4caf50;font-size:1.2rem;padding:15px 35px;margin-right:15px;">
                    <span class="status-indicator status-idle" id="status-indicator"></span>
                    <span id="btn-text">å¼€å§‹æ‰§è¡Œæ¿€å…‰é›·è¾¾ç”Ÿæˆ</span>
                </button>
                <button id="stop-script-btn" class="upload-btn" style="background:#f44336;font-size:1.2rem;padding:15px 35px;display:none;">
                    åœæ­¢æ‰§è¡Œ
                </button>
            </div>
            
            <!-- å¯è§†åŒ–æŒ‰é’® - å±…ä¸­æ˜¾ç¤º -->
            <div style="margin-top: 20px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
                <button id="visualization-btn" class="upload-btn" style="background:#2196f3;font-size:1.1rem;padding:12px 25px;">
                    ç”Ÿæˆå¯è§†åŒ–å›¾ç‰‡
                </button>
                <button id="show-results-btn" class="upload-btn" style="background:#9c27b0;font-size:1.1rem;padding:12px 25px;">
                    æ˜¾ç¤ºå¯è§†åŒ–ç»“æœ
                </button>
            </div>
            
            <!-- æç¤ºä¿¡æ¯ -->
            <div style="margin-top: 15px; text-align: center; color: #666; font-size: 0.95rem; line-height: 1.4;">
                ç”Ÿæˆæ•°æ®è€—æ—¶åœ¨10åˆ†é’Ÿå·¦å³ï¼ŒæœåŠ¡å™¨ä¸Šå·²å…·å¤‡å¯è§†åŒ–ç»“æœï¼Œç›´æ¥ç‚¹å‡»æŒ‰é’®å³å¯æ˜¾ç¤ºã€‚å¦‚æƒ³æ£€æµ‹ç”Ÿæˆæ¨¡å—è¯·å…ˆæ¸…é™¤ç¼“å­˜æ–‡ä»¶ã€‚
            </div>
        </div>

        <div class="result-area" id="result-area">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰§è¡Œæ¿€å…‰é›·è¾¾æ•°æ®ç”Ÿæˆç®—æ³•
        </div>

        <div class="output-container" id="output-container">
            <div style="color:#00bfff;margin-bottom:10px;">ğŸ“‹ å®æ—¶è¾“å‡ºæ—¥å¿—:</div>
            <div id="output-content"></div>
        </div>

        <!-- å¯è§†åŒ–ç»“æœæ˜¾ç¤ºå®¹å™¨ -->
        <div class="results-container" id="results-container">
            <button class="close-results-btn" onclick="closeResults()">å…³é—­ç»“æœ</button>
            <div class="results-title">æ¿€å…‰é›·è¾¾å¯è§†åŒ–ç»“æœ</div>
            <div id="results-content"></div>
        </div>

        <div style="text-align:center;color:#888;font-size:1.02rem;margin-top:38px;">
            å‰åç«¯æŠ€æœ¯æ”¯æŒï¼šæ–½é’§èˆ°
        </div>
    </div>

    <script>
        let isRunning = false;
        let outputInterval = null;
        let lastOutputLength = 0;
        let currentTaskId = null;

        const runBtn = document.getElementById('run-script-btn');
        const stopBtn = document.getElementById('stop-script-btn');
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        const visualizationBtn = document.getElementById('visualization-btn');
        const showResultsBtn = document.getElementById('show-results-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const btnText = document.getElementById('btn-text');
        const resultArea = document.getElementById('result-area');
        const outputContainer = document.getElementById('output-container');
        const outputContent = document.getElementById('output-content');
        const resultsContainer = document.getElementById('results-container');
        const resultsContent = document.getElementById('results-content');

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(status, text) {
            statusIndicator.className = 'status-indicator status-' + status;
            btnText.textContent = text;
        }

        // æ¸…ç†è¾“å‡ºç›‘æ§
        function cleanupOutputMonitoring() {
            if (outputInterval) {
                clearInterval(outputInterval);
                outputInterval = null;
            }
            stopBtn.style.display = 'none';
            currentTaskId = null;
        }

        // å¼€å§‹ç›‘æ§è¾“å‡º
        function startOutputMonitoring(taskId) {
            currentTaskId = taskId;
            lastOutputLength = 0;
            outputContent.innerHTML = '';
            outputContainer.classList.add('active');
            stopBtn.style.display = 'inline-block';
            
            outputInterval = setInterval(() => {
                fetch(`/get_task_output/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.output) {
                            const newOutput = data.output.substring(lastOutputLength);
                            if (newOutput) {
                                // å¯¹æ–°è¾“å‡ºè¿›è¡Œå…³é”®å­—é«˜äº®å¤„ç†
                                const highlightedOutput = highlightKeywords(newOutput);
                                outputContent.innerHTML += highlightedOutput;
                                outputContainer.scrollTop = outputContainer.scrollHeight;
                                lastOutputLength = data.output.length;
                            }
                        }
                        
                        // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ
                        if (data.completed) {
                            cleanupOutputMonitoring();
                            isRunning = false;
                            runBtn.disabled = false;
                            stopBtn.style.display = 'none';
                            currentTaskId = null;
                            
                            if (data.success) {
                                updateStatus('success', 'æ‰§è¡Œå®Œæˆ');
                                resultArea.innerHTML = '<div style="color:#4caf50;font-weight:bold;">âœ… æ¿€å…‰é›·è¾¾æ•°æ®ç”Ÿæˆå·²å®Œæˆï¼</div>';
                            } else {
                                updateStatus('error', 'æ‰§è¡Œå¤±è´¥');
                                resultArea.innerHTML = '<div style="color:#f44336;font-weight:bold;">âŒ æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—</div>';
                            }
                        }
                    })
                    .catch(err => {
                        console.error('è·å–è¾“å‡ºå¤±è´¥:', err);
                    });
            }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        }

        // å…³é”®å­—é«˜äº®å‡½æ•°
        function highlightKeywords(text) {
            // å®šä¹‰å…³é”®å­—å’Œå¯¹åº”çš„é¢œè‰²
            const keywordColors = {
                'level': '#ff6b6b',           // çº¢è‰²
                'step_size': '#4ecdc4',       // é’è‰²
                'grad_norm': '#45b7d1',       // è“è‰²
                'image_norm': '#f9ca24',      // é»„è‰²
                'snr': '#f0932b',             // æ©™è‰²
                'grad_mean_norm': '#eb4d4b'   // æ·±çº¢è‰²
            };
            
            let highlightedText = text;
            
            // å¯¹æ¯ä¸ªå…³é”®å­—è¿›è¡Œé«˜äº®å¤„ç†
            for (const [keyword, color] of Object.entries(keywordColors)) {
                // åŒ¹é…å…³é”®å­—åŠå…¶åé¢çš„å†’å·å’Œæ•°å€¼
                const regex = new RegExp(`(${keyword})(:\\s*[0-9.]+)`, 'gi');
                highlightedText = highlightedText.replace(regex, 
                    `<span style="color:${color};font-weight:bold;">$1</span><span style="color:#ffffff;">$2</span>`
                );
            }
            
            return highlightedText;
        }

        // å…³é—­å¯è§†åŒ–ç»“æœæ˜¾ç¤º
        function closeResults() {
            resultsContainer.classList.remove('active');
            resultsContent.innerHTML = '';
        }

        // æ˜¾ç¤ºå¯è§†åŒ–ç»“æœ
        function showVisualizationResults(imagePairs) {
            let html = '';
            
            imagePairs.forEach((pair, index) => {
                html += `
                    <div class="image-pair">
                        <div class="image-section">
                            <div class="image-label">3D ç‚¹äº‘ (${pair.index})</div>
                            <div class="image-container">
                                <img src="/lidar_visualization/ply_img/${pair.ply_image.filename}" 
                                     alt="3Dç‚¹äº‘ ${pair.index}" 
                                     class="result-image"
                                     style="display: block;">
                            </div>
                            <div class="image-info">æ–‡ä»¶: ${pair.ply_image.filename}</div>
                        </div>
                        
                        <div class="image-section">
                            <div class="image-label">èŒƒå›´ä¿¡æ¯ (${pair.index})</div>
                            <div class="image-container">
                                <img src="/lidar_visualization/range_img/${pair.range_image.filename}" 
                                     alt="èŒƒå›´ä¿¡æ¯ ${pair.index}" 
                                     class="result-image"
                                     style="display: block;">
                            </div>
                            <div class="image-info">æ–‡ä»¶: ${pair.range_image.filename}</div>
                        </div>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html;
            resultsContainer.classList.add('active');
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…é™¤ç¼“å­˜åŠŸèƒ½
        clearCacheBtn.onclick = function() {
            if (isRunning) {
                // ä¸ä½¿ç”¨alertï¼Œç›´æ¥åœ¨é¡µé¢æ˜¾ç¤ºæ¶ˆæ¯
                resultArea.innerHTML = '<div style="color:#ff9800;font-weight:bold;">âš ï¸ ä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡å†æ¸…é™¤ç¼“å­˜</div>';
                return;
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmMsg = 'ç¡®å®šè¦æ¸…é™¤ç¼“å­˜æ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤ unconditional_samples ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚';
            resultArea.innerHTML = `
                <div style="color:#ff9800;font-weight:bold;margin-bottom:15px;">âš ï¸ ${confirmMsg}</div>
                <div style="text-align:center;">
                    <button id="confirm-clear" style="background:#ff5722;color:white;border:none;padding:8px 15px;border-radius:4px;margin-right:10px;cursor:pointer;">ç¡®è®¤æ¸…é™¤</button>
                    <button id="cancel-clear" style="background:#666;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;">å–æ¶ˆ</button>
                </div>
            `;
            
            // ç»‘å®šç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('confirm-clear').onclick = function() {
                clearCacheBtn.disabled = true;
                clearCacheBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ¸…é™¤...';
                
                // å‘é€æ¸…é™¤ç¼“å­˜è¯·æ±‚
                fetch('/clear_lidar_cache', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cache_path: '/home/vipuser/home/huangff/lidargen-main/kitti_pretrained/unconditional_samples'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultArea.innerHTML = `<div style="color:#4caf50;font-weight:bold;">âœ… ç¼“å­˜æ¸…é™¤æˆåŠŸï¼åˆ é™¤äº† ${data.deleted_count || 0} ä¸ªæ–‡ä»¶</div>`;
                    } else {
                        throw new Error(data.error || 'æ¸…é™¤ç¼“å­˜å¤±è´¥');
                    }
                })
                .catch(err => {
                    resultArea.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥: ${err.message}</div>`;
                    console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', err);
                })
                .finally(() => {
                    clearCacheBtn.disabled = false;
                    clearCacheBtn.innerHTML = 'æ¸…é™¤ç¼“å­˜æ–‡ä»¶';
                });
            };
            
            document.getElementById('cancel-clear').onclick = function() {
                resultArea.innerHTML = '<div style="color:#666;">æ¸…é™¤ç¼“å­˜æ“ä½œå·²å–æ¶ˆ</div>';
            };
        };

        // æ‰§è¡Œè„šæœ¬æŒ‰é’®äº‹ä»¶
        runBtn.onclick = function() {
            if (isRunning) {
                alert('å·²æœ‰ä»»åŠ¡æ­£åœ¨è¿è¡Œï¼Œè¯·å…ˆåœæ­¢å½“å‰ä»»åŠ¡');
                return;
            }
            
            isRunning = true;
            runBtn.disabled = true;
            updateStatus('running', 'æ­£åœ¨æ‰§è¡Œä¸­...');
            resultArea.innerHTML = '<div style="color:#ff9800;">ğŸ”„ æ­£åœ¨å¯åŠ¨æ¿€å…‰é›·è¾¾æ•°æ®ç”Ÿæˆç®—æ³•ï¼Œè¯·è€å¿ƒç­‰å¾…...</div>';
            
            // å‘é€æ‰§è¡Œè¯·æ±‚
            fetch('/run_lidar_script', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.task_id) {
                    resultArea.innerHTML = '<div style="color:#1769aa;">ğŸ“Š ç®—æ³•å·²å¯åŠ¨ï¼Œæ­£åœ¨å®æ—¶æ˜¾ç¤ºè¾“å‡ºæ—¥å¿—...</div>';
                    startOutputMonitoring(data.task_id);
                } else {
                    throw new Error(data.error || 'å¯åŠ¨å¤±è´¥');
                }
            })
            .catch(err => {
                isRunning = false;
                runBtn.disabled = false;
                currentTaskId = null;
                updateStatus('error', 'å¯åŠ¨å¤±è´¥');
                resultArea.innerHTML = `<div style="color:#f44336;">âŒ å¯åŠ¨å¤±è´¥: ${err.message}</div>`;
                console.error('å¯åŠ¨è„šæœ¬å¤±è´¥:', err);
            });
        };

        // åœæ­¢è„šæœ¬æŒ‰é’®äº‹ä»¶
        stopBtn.onclick = function() {
            if (!isRunning || !currentTaskId) return;
            
            stopBtn.disabled = true;
            stopBtn.innerHTML = 'æ­£åœ¨åœæ­¢...';
            
            // å‘é€åœæ­¢è¯·æ±‚
            fetch(`/stop_task/${currentTaskId}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cleanupOutputMonitoring();
                    isRunning = false;
                    runBtn.disabled = false;
                    stopBtn.style.display = 'none';
                    currentTaskId = null;
                    updateStatus('error', 'å·²åœæ­¢');
                    resultArea.innerHTML = '<div style="color:#ff9800;font-weight:bold;">ğŸ›‘ æ‰§è¡Œå·²è¢«ç”¨æˆ·ä¸­æ–­</div>';
                    outputContent.innerHTML += '\n\n<span style="color:#ff9800;font-weight:bold;">=== æ‰§è¡Œå·²è¢«ç”¨æˆ·ä¸­æ–­ ===</span>\n';
                } else {
                    throw new Error(data.error || 'åœæ­¢å¤±è´¥');
                }
            })
            .catch(err => {
                console.error('åœæ­¢å¤±è´¥:', err);
                resultArea.innerHTML = `<div style="color:#f44336;">âŒ åœæ­¢å¤±è´¥: ${err.message}</div>`;
            })
            .finally(() => {
                stopBtn.disabled = false;
                stopBtn.innerHTML = 'åœæ­¢æ‰§è¡Œ';
            });
        };

        // ç”Ÿæˆå¯è§†åŒ–å›¾ç‰‡æŒ‰é’®äº‹ä»¶
        visualizationBtn.onclick = function() {
            visualizationBtn.disabled = true;
            visualizationBtn.innerHTML = 'ğŸ”„ æ­£åœ¨æ‰§è¡Œ...';
            resultArea.innerHTML = '<div style="color:#2196f3;">ğŸ” æ­£åœ¨æ£€æŸ¥ç¼“å­˜æ–‡ä»¶å¹¶ç”Ÿæˆå¯è§†åŒ–å›¾ç‰‡...</div>';
            
            // å‘é€å¯è§†åŒ–è¯·æ±‚
            fetch('/run_lidar_visualization', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultArea.innerHTML = `<div style="color:#4caf50;font-weight:bold;">âœ… å¯è§†åŒ–ç”Ÿæˆå®Œæˆï¼å¤„ç†äº† ${data.files_count} ä¸ªæ–‡ä»¶</div>`;
                    if (data.output) {
                        outputContent.innerHTML = data.output;
                        outputContainer.classList.add('active');
                    }
                } else {
                    resultArea.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ ${data.error}</div>`;
                    if (data.output || data.stderr) {
                        outputContent.innerHTML = (data.output || '') + '\n' + (data.stderr || '');
                        outputContainer.classList.add('active');
                    }
                }
            })
            .catch(err => {
                resultArea.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ è¯·æ±‚å¤±è´¥: ${err.message}</div>`;
                console.error('å¯è§†åŒ–è¯·æ±‚å¤±è´¥:', err);
            })
            .finally(() => {
                visualizationBtn.disabled = false;
                visualizationBtn.innerHTML = 'ç”Ÿæˆå¯è§†åŒ–å›¾ç‰‡';
            });
        };

        // æ˜¾ç¤ºå¯è§†åŒ–ç»“æœæŒ‰é’®äº‹ä»¶
        showResultsBtn.onclick = function() {
            showResultsBtn.disabled = true;
            showResultsBtn.innerHTML = 'ğŸ”„ åŠ è½½ä¸­...';
            
            fetch('/get_lidar_visualization_results')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.image_pairs && data.image_pairs.length > 0) {
                            showVisualizationResults(data.image_pairs);
                            resultArea.innerHTML = `<div style="color:#4caf50;font-weight:bold;">âœ… æˆåŠŸåŠ è½½äº† ${data.image_pairs.length} ç»„å¯è§†åŒ–ç»“æœ</div>`;
                        } else {
                            resultArea.innerHTML = '<div style="color:#ff9800;font-weight:bold;">âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯è§†åŒ–ç»“æœã€‚è¯·å…ˆè¿è¡Œ"ç”Ÿæˆå¯è§†åŒ–å›¾ç‰‡"</div>';
                        }
                    } else {
                        resultArea.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ åŠ è½½å¯è§†åŒ–ç»“æœå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultArea.innerHTML = `<div style="color:#f44336;font-weight:bold;">âŒ åŠ è½½å¯è§†åŒ–ç»“æœæ—¶å‘ç”Ÿé”™è¯¯: ${error.message}</div>`;
                })
                .finally(() => {
                    showResultsBtn.disabled = false;
                    showResultsBtn.innerHTML = 'æ˜¾ç¤ºå¯è§†åŒ–ç»“æœ';
                });
        };

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            cleanupOutputMonitoring();
        });
    </script>
</body>
</html>
